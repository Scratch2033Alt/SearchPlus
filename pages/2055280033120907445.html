<!DOCTYPE html><html lang="en" dir="ltr"><head>
<meta charset="utf-8">
<meta name="generator" content="ReSpec 35.4.2">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<style>
span.example-title{text-transform:none}
:is(aside,div).example,div.illegal-example{padding:.5em;margin:1em 0;position:relative;clear:both}
div.illegal-example{color:red}
div.illegal-example p{color:#000}
aside.example div.example{border-left-width:.1em;border-color:#999;background:#fff}
</style>
<style>
dfn{cursor:pointer}
.dfn-panel{position:absolute;z-index:35;min-width:300px;max-width:500px;padding:.5em .75em;margin-top:.6em;font-family:"Helvetica Neue",sans-serif;font-size:small;background:#fff;background:var(--indextable-hover-bg,#fff);color:#000;color:var(--text,#000);box-shadow:0 1em 3em -.4em rgba(0,0,0,.3),0 0 1px 1px rgba(0,0,0,.05);box-shadow:0 1em 3em -.4em var(--tocsidebar-shadow,rgba(0,0,0,.3)),0 0 1px 1px var(--tocsidebar-shadow,rgba(0,0,0,.05));border-radius:2px}
.dfn-panel:not(.docked)>.caret{position:absolute;top:-9px}
.dfn-panel:not(.docked)>.caret::after,.dfn-panel:not(.docked)>.caret::before{content:"";position:absolute;border:10px solid transparent;border-top:0;border-bottom:10px solid #fff;border-bottom-color:var(--indextable-hover-bg,#fff);top:0}
.dfn-panel:not(.docked)>.caret::before{border-bottom:9px solid #a2a9b1;border-bottom-color:var(--indextable-hover-bg,#a2a9b1)}
.dfn-panel *{margin:0}
.dfn-panel b{display:block;color:#000;color:var(--text,#000);margin-top:.25em}
.dfn-panel ul a[href]{color:#333;color:var(--text,#333)}
.dfn-panel>div{display:flex}
.dfn-panel a.self-link{font-weight:700;margin-right:auto}
.dfn-panel .marker{padding:.1em;margin-left:.5em;border-radius:.2em;text-align:center;white-space:nowrap;font-size:90%;color:#040b1c}
.dfn-panel .marker.dfn-exported{background:#d1edfd;box-shadow:0 0 0 .125em #1ca5f940}
.dfn-panel .marker.idl-block{background:#8ccbf2;box-shadow:0 0 0 .125em #0670b161}
.dfn-panel a:not(:hover){text-decoration:none!important;border-bottom:none!important}
.dfn-panel a[href]:hover{border-bottom-width:1px}
.dfn-panel ul{padding:0}
.dfn-panel li{margin-left:1em}
.dfn-panel.docked{position:fixed;left:.5em;top:unset;bottom:2em;margin:0 auto;max-width:calc(100vw - .75em * 2 - .5em - .2em * 2);max-height:30vh;overflow:auto}
</style>
		
<title>SHACL 1.2 SPARQL Extensions</title>
		
		
		
		
<style>


			pre {
				tab-size: 3;
				-moz-tab-size: 3; /* Code for Firefox */
				-o-tab-size: 3; /* Code for Opera */
			}

			th {
				text-align: left;
			}
			table.rule { background-color: #EBEBE0; }
			table.rule td { text-align: center; }
			td.up { border-bottom:1px solid black; }
			
			td {
				vertical-align: top;
			}
			
			.algorithm {
				background: #fafafc;
				border-left-style: solid;
				border-left-width: .5em;
				border-color: #c0c0c0;
				margin-bottom: 16px;
				padding: 8px;
			}
			
			.arg {
				font-weight: bold;
				color: #000080;
			}

			.def {
				background: #fcfcfc;
				border-left-style: solid;
				border-left-width: .5em;
				border-color: #c0c0c0;
				margin-bottom: 16px;
			}
			
			.def-sparql {
			}
			
			.def-sparql-body {
				margin-top: 0px;
				margin-bottom: 0px;
			}
			
			.def-text {
			}
			
			.def-text-body {
			}
			
			.def-header {
				color: #a0a0a0;
				font-size: 16px;
				padding-bottom: 8px;
			}
			
			.diagram-class {
				border: 1px solid black; 
				border-radius: 4px; 
				width: 360px;
			}
			
			.diagram-class-name {
				font-size: 16px; 
				font-weight: bold; 
				text-align: center;
			}
			
			.diagram-class-properties {
				border-top: 1px solid black; 
			}
			
			.diagram-class-properties-start {
				padding: 8px;
			}
			
			.diagram-class-properties-section {
				border-top: 1px dashed #808080;
				padding: 8px;
			}
			
			.example {
				overflow-y: hidden !important;
			}

			.focus-node-selected {
				color: blue;
			}
			.focus-node-error {
				color: red;
			}

			.triple-can-be-skipped {
				color: grey;
			}
			.focus-node-error {
				color: red;
			}

			.target-can-be-skipped {
				color: darkslategray;
				font-style: italic;
			}
			
			.component-class {
				font-weight: bold;
				font-size: 16px;
			}
			
			.parameter-context {
				font-weight: bold;
				font-size: 16px;
			}
			
			.parameters {
				font-weight: bold;
				font-size: 16px;
			}

			.part-header {
				font-weight: bold;
			}
			
			.syntax {
				border-left-style: solid;
				border-left-width: .5em;
				border-color: #d0d0d0;
				margin-bottom: 16px;
				padding: .5em 1em;
				background-color: #f6f6f6;
			}
			
			.syntax-rule-id {
				padding-right: 10px;
			}
			
			.syntax-rule-id-a {
				white-space: nowrap;
			}
			
			.validator-id-a {
				font-weight: bold;
				white-space: nowrap;
			}
		
			.term {
				font-style: italic;
			}
			
			.term-def-header {
				font-style: italic;
				font-weight: bold;
			}
		
			.term-table {
				border-collapse: collapse;
				border-color: #000000;
				margin: 16px;
			}

			.term-table td, th {
				border-width: 1px;
				border-style: solid;
				padding: 5px;
			}
		
			.todo {
				color: red;
			}

			.turtle {
				font-family: Menlo, Consolas, "DejaVu Sans Mono", Monaco, monospace;
				font-size: 14.4px;
				hyphens: none;
				overflow-x: auto;
				padding: .5em;
				tab-size: 3;
				-moz-tab-size: 3; /* Code for Firefox */
				-o-tab-size: 3; /* Code for Opera */
				text-align: start;
				margin-bottom: -1.5em;
				margin-top: -1.5em;
				white-space: pre;
			}
			
			.data-graph { 
				background: #eeb; 
				border: 1px solid #cc9;
				margin-top: 0.3em;
			}
			.data-graph:before { 
				color: #996; 
				content: "Data graph"; 
				padding-left: 0.4em;
			}
			
			.results-graph { 
				background: #edb; 
				border: 1px solid #bbb;
				margin-top: 0.3em;
			}
			.results-graph:before { 
				color: #997; 
				content: "Validation results"; 
				padding-left: 0.4em;
			}
			
			.shapes-graph { 
				background: #deb; 
				border: 1px solid #bbb;
				margin-top: 0.3em;
			}
			.shapes-graph:before { 
				color: #888; 
				content: "Shapes graph"; 
				padding-left: 0.4em;
			}

			/* no dark mode, keep colors for shapes-graph, data-graph, and results graph background */
			code.hljs {
				--base: transparent;
				--mono-1: #383a42;
			}

			/* example tab selection */
			.ds-selector-tabs .selectors {
				padding: 0;
				border-bottom: 1px solid #ccc;
				height: 28px;
			}
			.ds-selector-tabs .selectors button {
				display: inline-block;
				min-width: 54px;
				text-align: center;
				font-size: 11px;
				font-weight: bold;
				height: 27px;
				padding: 0 8px;
				line-height: 27px;
				transition: all,0.218s;
				border-top-right-radius: 2px;
				border-top-left-radius: 2px;
				color: #666;
				border: 1px solid transparent;
			}
			.ds-selector-tabs .selectors button:first-child {
				margin-left: 2px;
			}
			.ds-selector-tabs .selectors button.selected {
				color: #202020 !important;
				border: 1px solid #ccc;
				border-bottom: 1px solid #fff !important;
			}
			.ds-selector-tabs .selectors button:hover {
				background-color: transparent;
				color: #202020;
				cursor: pointer;
			}
			.ds-selector-tabs .tab {
				display: none;
			}
			.ds-selector-tabs .selected {
				display: block;
			}
		
</style>
	
<style id="respec-mainstyle">
@keyframes pop{
0%{transform:scale(1,1)}
25%{transform:scale(1.25,1.25);opacity:.75}
100%{transform:scale(1,1)}
}
a.internalDFN{color:inherit;border-bottom:1px solid #99c;text-decoration:none}
a.externalDFN{color:inherit;border-bottom:1px dotted #ccc;text-decoration:none}
a.bibref{text-decoration:none}
.respec-offending-element:target{animation:pop .25s ease-in-out 0s 1}
.respec-offending-element,a[href].respec-offending-element{text-decoration:red wavy underline}
@supports not (text-decoration:red wavy underline){
.respec-offending-element:not(pre){display:inline-block}
.respec-offending-element{background:url(data:image/gif;base64,R0lGODdhBAADAPEAANv///8AAP///wAAACwAAAAABAADAEACBZQjmIAFADs=) bottom repeat-x}
}
#references :target{background:#eaf3ff;animation:pop .4s ease-in-out 0s 1}
cite .bibref{font-style:italic}
a[href].orcid{padding-left:4px;padding-right:4px}
a[href].orcid>svg{margin-bottom:-2px}
ol.tof,ul.tof{list-style:none outside none}
.caption{margin-top:.5em;font-style:italic}
#issue-summary>ul{column-count:2}
#issue-summary li{list-style:none;display:inline-block}
details.respec-tests-details{margin-left:1em;display:inline-block;vertical-align:top}
details.respec-tests-details>*{padding-right:2em}
details.respec-tests-details[open]{z-index:999999;position:absolute;border:thin solid #cad3e2;border-radius:.3em;background-color:#fff;padding-bottom:.5em}
details.respec-tests-details[open]>summary{border-bottom:thin solid #cad3e2;padding-left:1em;margin-bottom:1em;line-height:2em}
details.respec-tests-details>ul{width:100%;margin-top:-.3em}
details.respec-tests-details>li{padding-left:1em}
.self-link:hover{opacity:1;text-decoration:none;background-color:transparent}
aside.example .marker>a.self-link{color:inherit}
.header-wrapper{display:flex;align-items:baseline}
:is(h2,h3,h4,h5,h6):not(#toc>h2,#abstract>h2,#sotd>h2,.head>h2){position:relative;left:-.5em}
:is(h2,h3,h4,h5,h6):not(#toch2)+a.self-link{color:inherit;order:-1;position:relative;left:-1.1em;font-size:1rem;opacity:.5}
:is(h2,h3,h4,h5,h6)+a.self-link::before{content:"ยง";text-decoration:none;color:var(--heading-text)}
:is(h2,h3)+a.self-link{top:-.2em}
:is(h4,h5,h6)+a.self-link::before{color:#000}
@media (max-width:767px){
dd{margin-left:0}
}
@media print{
.removeOnSave{display:none}
}
</style>
<meta name="color-scheme" content="light">
<meta name="revision" content="91302aa58710ec94fcd1f387859449ff7c32df74">
<meta name="description" content="This document defines SPARQL-related extensions of the SHACL Shapes Constraint Language.
				SHACL is a language for validating RDF graphs against a set of conditions.
				These conditions are provided as shapes and other constructs expressed in the form of an RDF graph.
				While the Core part of SHACL defines the basic syntax of shapes and the most common constraint components
				supported by SHACL, the SPARQL-related extensions cover features that extend the expressiveness of Core
				by means of SPARQL.
				In particular, this document defines how constraints and constraint components can be defined using SPARQL.">
<link rel="canonical" href="https://www.w3.org/TR/shacl12-sparql/">
<style>
.hljs{--base:#fafafa;--mono-1:#383a42;--mono-2:#686b77;--mono-3:#717277;--hue-1:#0b76c5;--hue-2:#336ae3;--hue-3:#a626a4;--hue-4:#42803c;--hue-5:#ca4706;--hue-5-2:#c91243;--hue-6:#986801;--hue-6-2:#9a6a01}
@media (prefers-color-scheme:dark){
.hljs{--base:#282c34;--mono-1:#abb2bf;--mono-2:#818896;--mono-3:#5c6370;--hue-1:#56b6c2;--hue-2:#61aeee;--hue-3:#c678dd;--hue-4:#98c379;--hue-5:#e06c75;--hue-5-2:#be5046;--hue-6:#d19a66;--hue-6-2:#e6c07b}
}
.hljs{display:block;overflow-x:auto;padding:.5em;color:#383a42;color:var(--mono-1,#383a42);background:#fafafa;background:var(--base,#fafafa)}
.hljs-comment,.hljs-quote{color:#717277;color:var(--mono-3,#717277);font-style:italic}
.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4;color:var(--hue-3,#a626a4)}
.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#ca4706;color:var(--hue-5,#ca4706);font-weight:700}
.hljs-literal{color:#0b76c5;color:var(--hue-1,#0b76c5)}
.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#42803c;color:var(--hue-4,#42803c)}
.hljs-built_in,.hljs-class .hljs-title{color:#9a6a01;color:var(--hue-6-2,#9a6a01)}
.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801;color:var(--hue-6,#986801)}
.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#336ae3;color:var(--hue-2,#336ae3)}
.hljs-emphasis{font-style:italic}
.hljs-strong{font-weight:700}
.hljs-link{text-decoration:underline}
</style>
<style>
var:hover{text-decoration:underline;cursor:pointer}
var.respec-hl{color:var(--color,#000);background-color:var(--bg-color);box-shadow:0 0 0 2px var(--bg-color)}
@media (prefers-color-scheme:dark){
var.respec-hl{filter:saturate(.9) brightness(.9)}
}
var.respec-hl-c1{--bg-color:#f4d200}
var.respec-hl-c2{--bg-color:#ff87a2}
var.respec-hl-c3{--bg-color:#96e885}
var.respec-hl-c4{--bg-color:#3eeed2}
var.respec-hl-c5{--bg-color:#eacfb6}
var.respec-hl-c6{--bg-color:#82ddff}
var.respec-hl-c7{--bg-color:#ffbcf2}
@media print{
var.respec-hl{background:0 0;color:#000;box-shadow:unset}
}
</style>
<style>
var{position:relative;cursor:pointer}
var[data-type]::after,var[data-type]::before{position:absolute;left:50%;top:-6px;opacity:0;transition:opacity .4s;pointer-events:none}
var[data-type]::before{content:"";transform:translateX(-50%);border-width:4px 6px 0 6px;border-style:solid;border-color:transparent;border-top-color:#222}
var[data-type]::after{content:attr(data-type);transform:translateX(-50%) translateY(-100%);background:#222;text-align:center;font-family:"Dank Mono","Fira Code",monospace;font-style:normal;padding:6px;border-radius:3px;color:#daca88;text-indent:0;font-weight:400}
var[data-type]:hover::after,var[data-type]:hover::before{opacity:1}
</style>
<script id="initialUserConfig" type="application/json">{
  "group": "wg/data-shapes",
  "github": "w3c/data-shapes",
  "edDraftURI": "https://w3c.github.io/data-shapes/shacl12-sparql/",
  "specStatus": "WD",
  "preProcess": [
    null,
    null
  ],
  "shortName": "shacl12-sparql",
  "subjectPrefix": "[shacl12-sparql]",
  "editors": [
    {
      "name": "Holger Knublauch",
      "company": "TopQuadrant, Inc.",
      "companyURL": "http://topquadrant.com/",
      "mailto": "holger@topquadrant.com",
      "w3cid": 46500,
      "url": "mailto:holger@topquadrant.com"
    },
    {
      "name": "Ashley Sommer",
      "company": "CSIRO",
      "companyURL": "https://csiro.au",
      "mailto": "ashley.sommer@csiro.au",
      "w3cid": 155924,
      "url": "mailto:ashley.sommer@csiro.au"
    }
  ],
  "formerEditors": [
    {
      "name": "Dimitris Kontokostas",
      "w3cid": 58399
    }
  ],
  "testSuiteURI": "https://w3c.github.io/data-shapes/data-shapes-test-suite/",
  "previousPublishDate": "2025-03-18",
  "previousMaturity": "WD",
  "prevRecShortname": "shacl",
  "prevRecURI": "https://www.w3.org/TR/2017/REC-shacl-20170720/#part2",
  "lint": {
    "no-unused-dfns": false
  },
  "wgPublicList": "public-shacl",
  "gitRevision": "91302aa58710ec94fcd1f387859449ff7c32df74",
  "publishDate": "2025-07-07",
  "publishISODate": "2025-07-07T00:00:00.000Z",
  "generatedSubtitle": "W3C Working Draft 07 July 2025"
}</script>
<link rel="stylesheet" href="https://www.w3.org/StyleSheets/TR/2021/W3C-WD"></head>
	<body class="h-entry"><div class="head">
    <p class="logos"><a class="logo" href="https://www.w3.org/"><img crossorigin="" alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72">
  </a></p>
    <h1 id="title" class="title">SHACL 1.2 SPARQL Extensions</h1> 
    <p id="w3c-state"><a href="https://www.w3.org/standards/types#WD">W3C Working Draft</a> <time class="dt-published" datetime="2025-07-07">07 July 2025</time></p>
    <details open="">
      <summary>More details about this document</summary>
      <dl>
        <dt>This version:</dt><dd>
                <a class="u-url" href="https://www.w3.org/TR/2025/WD-shacl12-sparql-20250707/">https://www.w3.org/TR/2025/WD-shacl12-sparql-20250707/</a>
              </dd>
        <dt>Latest published version:</dt><dd>
                <a href="https://www.w3.org/TR/shacl12-sparql/">https://www.w3.org/TR/shacl12-sparql/</a>
              </dd>
        <dt>Latest editor's draft:</dt><dd><a href="https://w3c.github.io/data-shapes/shacl12-sparql/">https://w3c.github.io/data-shapes/shacl12-sparql/</a></dd>
        <dt>History:</dt><dd>
                    <a href="https://www.w3.org/standards/history/shacl12-sparql/">https://www.w3.org/standards/history/shacl12-sparql/</a>
                  </dd><dd>
                    <a href="https://github.com/w3c/data-shapes/commits/">Commit history</a>
                  </dd>
        <dt>Test suite:</dt><dd><a href="https://w3c.github.io/data-shapes/data-shapes-test-suite/">https://w3c.github.io/data-shapes/data-shapes-test-suite/</a></dd>
        
        
        
        <dt>Latest Recommendation:</dt><dd><a href="https://www.w3.org/TR/2017/REC-shacl-20170720/#part2">https://www.w3.org/TR/2017/REC-shacl-20170720/#part2</a></dd>
        <dt>Editors:</dt><dd class="editor p-author h-card vcard" data-editor-id="46500">
    <a class="ed_mailto u-email email p-name" href="mailto:holger@topquadrant.com">Holger Knublauch</a> (<a class="p-org org h-org" href="http://topquadrant.com/">TopQuadrant, Inc.</a>)
  </dd><dd class="editor p-author h-card vcard" data-editor-id="155924">
    <a class="ed_mailto u-email email p-name" href="mailto:ashley.sommer@csiro.au">Ashley Sommer</a> (<a class="p-org org h-org" href="https://csiro.au">CSIRO</a>)
  </dd>
        <dt>
                Former editor:
              </dt><dd class="editor p-author h-card vcard" data-editor-id="58399">
    <span class="p-name fn">Dimitris Kontokostas</span>
  </dd>
        
        <dt>Feedback:</dt><dd>
        <a href="https://github.com/w3c/data-shapes/">GitHub w3c/data-shapes</a>
        (<a href="https://github.com/w3c/data-shapes/pulls/">pull requests</a>,
        <a href="https://github.com/w3c/data-shapes/issues/new/choose">new issue</a>,
        <a href="https://github.com/w3c/data-shapes/issues/">open issues</a>)
      </dd><dd><a href="mailto:public-shacl@w3.org?subject=%5Bshacl12-sparql%5D">public-shacl@w3.org</a> with subject line <kbd>[shacl12-sparql]</kbd> (<a rel="discussion" href="https://lists.w3.org/Archives/Public/public-shacl">archives</a>)</dd>
        
        
      </dl>
    </details>
    
    
    <p class="copyright">
    <a href="https://www.w3.org/policies/#copyright">Copyright</a>
    ยฉ
    2025
    
    <a href="https://www.w3.org/">World Wide Web Consortium</a>.
    <abbr title="World Wide Web Consortium">W3C</abbr><sup>ยฎ</sup>
    <a href="https://www.w3.org/policies/#Legal_Disclaimer">liability</a>,
    <a href="https://www.w3.org/policies/#W3C_Trademarks">trademark</a> and
    <a rel="license" href="https://www.w3.org/copyright/software-license-2023/" title="W3C Software and Document Notice and License">permissive document license</a> rules apply.
  </p>
    <hr title="Separator for header">
  </div>

		<section id="abstract" class="introductory"><h2>Abstract</h2>
			<p>
				This document defines SPARQL-related extensions of the SHACL Shapes Constraint Language.
				SHACL is a language for validating RDF graphs against a set of conditions.
				These conditions are provided as shapes and other constructs expressed in the form of an RDF graph.
				While the Core part of SHACL defines the basic syntax of shapes and the most common constraint components
				supported by SHACL, the SPARQL-related extensions cover features that extend the expressiveness of Core
				by means of SPARQL.
				In particular, this document defines how constraints and constraint components can be defined using SPARQL.
			</p>
			<p class="todo">
				TODO: More will be added on Node Expressions/targets once that part is ready.
				Other features from SHACL-AF such as user-defined functions may get added.
			</p>
		</section>

		<section id="sotd" class="introductory"><h2>Status of This Document</h2><p><em>This section describes the status of this
      document at the time of its publication. A list of current <abbr title="World Wide Web Consortium">W3C</abbr>
      publications and the latest revision of this technical report can be found
      in the
      <a href="https://www.w3.org/TR/"><abbr title="World Wide Web Consortium">W3C</abbr> standards and drafts index</a>.</em></p>
		<p>
    This document was published by the <a href="https://www.w3.org/groups/wg/data-shapes">Data Shapes Working Group</a> as
    a Working Draft using the
        <a href="https://www.w3.org/policies/process/20231103/#recs-and-notes">Recommendation track</a>. 
  </p><p>Publication as a Working Draft does not
  imply endorsement by <abbr title="World Wide Web Consortium">W3C</abbr> and its Members. </p><p>
    This is a draft document and may be updated, replaced, or obsoleted by other
    documents at any time. It is inappropriate to cite this document as other
    than a work in progress.
    
  </p><p>
    
        This document was produced by a group
        operating under the
        <a href="https://www.w3.org/policies/patent-policy/"><abbr title="World Wide Web Consortium">W3C</abbr> Patent
          Policy</a>.
      
    
                <abbr title="World Wide Web Consortium">W3C</abbr> maintains a
                <a rel="disclosure" href="https://www.w3.org/groups/wg/data-shapes/ipr">public list of any patent disclosures</a>
          made in connection with the deliverables of
          the group; that page also includes
          instructions for disclosing a patent. An individual who has actual
          knowledge of a patent that the individual believes contains
          <a href="https://www.w3.org/policies/patent-policy/#def-essential">Essential Claim(s)</a>
          must disclose the information in accordance with
          <a href="https://www.w3.org/policies/patent-policy/#sec-Disclosure">section 6 of the <abbr title="World Wide Web Consortium">W3C</abbr> Patent Policy</a>.
        
  </p><p>
                      This document is governed by the
                      <a id="w3c_process_revision" href="https://www.w3.org/policies/process/20231103/">03 November 2023 <abbr title="World Wide Web Consortium">W3C</abbr> Process Document</a>.
                    </p></section><nav id="toc"><h2 class="introductory" id="table-of-contents">Table of Contents</h2><ol class="toc"><li class="tocline"><a class="tocxref" href="#abstract">Abstract</a></li><li class="tocline"><a class="tocxref" href="#sotd">Status of This Document</a></li><li class="tocline"><a class="tocxref" href="#introduction"><bdi class="secno">1. </bdi>Introduction</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#terminology"><bdi class="secno">1.1 </bdi>Terminology</a></li><li class="tocline"><a class="tocxref" href="#conventions"><bdi class="secno">1.2 </bdi>Document Conventions</a></li><li class="tocline"><a class="tocxref" href="#conformance"><bdi class="secno">1.3 </bdi>Conformance</a></li></ol></li><li class="tocline"><a class="tocxref" href="#sparql-constraints"><bdi class="secno">2. </bdi>SPARQL-based Constraints</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#sparql-constraints-example"><bdi class="secno">2.1 </bdi>An Example SPARQL-based Constraint</a></li><li class="tocline"><a class="tocxref" href="#sparql-constraints-syntax"><bdi class="secno">2.2 </bdi>Syntax of SPARQL-based Constraints</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#sparql-prefixes"><bdi class="secno">2.2.1 </bdi>Prefix Declarations for SPARQL Queries</a></li></ol></li><li class="tocline"><a class="tocxref" href="#sparql-constraints-validation"><bdi class="secno">2.3 </bdi>Validation with SPARQL-based Constraints</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#sparql-constraints-prebound"><bdi class="secno">2.3.1 </bdi>Pre-bound Variables in SPARQL Constraints ($this, $shapesGraph, $currentShape)</a></li><li class="tocline"><a class="tocxref" href="#sparql-constraints-variables"><bdi class="secno">2.3.2 </bdi>Mapping of Solution Bindings to Result Properties</a></li></ol></li></ol></li><li class="tocline"><a class="tocxref" href="#sparql-constraint-components"><bdi class="secno">3. </bdi>SPARQL-based Constraint Components</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#an-example-sparql-based-constraint-component"><bdi class="secno">3.1 </bdi>An Example SPARQL-based Constraint Component</a></li><li class="tocline"><a class="tocxref" href="#constraint-components-syntax"><bdi class="secno">3.2 </bdi>Syntax of SPARQL-based Constraint Components</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#constraint-components-parameters"><bdi class="secno">3.2.1 </bdi>Parameter Declarations (sh:parameter)</a></li><li class="tocline"><a class="tocxref" href="#labelTemplate"><bdi class="secno">3.2.2 </bdi>Label Templates (sh:labelTemplate)</a></li><li class="tocline"><a class="tocxref" href="#constraint-components-validators"><bdi class="secno">3.2.3 </bdi>Validators</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#SPARQLSelectValidator"><bdi class="secno">3.2.3.1 </bdi>SELECT-based Validators</a></li><li class="tocline"><a class="tocxref" href="#SPARQLAskValidator"><bdi class="secno">3.2.3.2 </bdi>ASK-based Validators</a></li></ol></li></ol></li><li class="tocline"><a class="tocxref" href="#constraint-components-validation"><bdi class="secno">3.3 </bdi>Validation with SPARQL-based Constraint Components</a></li></ol></li><li class="tocline"><a class="tocxref" href="#sparql-constraints-annotations"><bdi class="secno">4. </bdi>Annotation Properties</a></li><li class="tocline"><a class="tocxref" href="#sparql-node-expressions"><bdi class="secno">5. </bdi>SPARQL-based Node Expressions</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#SelectExpression"><bdi class="secno">5.1 </bdi>Select Expressions</a></li><li class="tocline"><a class="tocxref" href="#SPARQLExprExpression"><bdi class="secno">5.2 </bdi>SPARQL Expr Expressions</a></li></ol></li><li class="tocline"><a class="tocxref" href="#pre-binding"><bdi class="secno">A. </bdi>Pre-binding of Variables in SPARQL Queries</a></li><li class="tocline"><a class="tocxref" href="#syntax-rules"><bdi class="secno">B. </bdi>Summary of SHACL Syntax Rules</a></li><li class="tocline"><a class="tocxref" href="#sparql-definitions-core"><bdi class="secno">C. </bdi>Potential SPARQL Definitions of SHACL Core Constraint Validators</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#sparql-definition-targetClass"><bdi class="secno">C.1 </bdi>sh:targetClass</a></li><li class="tocline"><a class="tocxref" href="#sparql-definition-targetSubjectsOf"><bdi class="secno">C.2 </bdi>sh:targetSubjectsOf</a></li><li class="tocline"><a class="tocxref" href="#sparql-definition-targetObjectsOf"><bdi class="secno">C.3 </bdi>sh:targetObjectsOf</a></li><li class="tocline"><a class="tocxref" href="#sparql-definition-class"><bdi class="secno">C.4 </bdi>sh:class</a></li><li class="tocline"><a class="tocxref" href="#sparql-definition-nodeKind"><bdi class="secno">C.5 </bdi>sh:nodeKind</a></li><li class="tocline"><a class="tocxref" href="#sparql-definition-minExclusive"><bdi class="secno">C.6 </bdi>sh:minExclusive (etc)</a></li><li class="tocline"><a class="tocxref" href="#sparql-definition-minLength"><bdi class="secno">C.7 </bdi>sh:minLength</a></li><li class="tocline"><a class="tocxref" href="#sparql-definition-maxLength"><bdi class="secno">C.8 </bdi>sh:maxLength</a></li><li class="tocline"><a class="tocxref" href="#sparql-definition-pattern"><bdi class="secno">C.9 </bdi>sh:pattern</a></li><li class="tocline"><a class="tocxref" href="#sparql-definition-disjoint"><bdi class="secno">C.10 </bdi>sh:disjoint</a></li><li class="tocline"><a class="tocxref" href="#sparql-definition-lessThan"><bdi class="secno">C.11 </bdi>sh:lessThan</a></li><li class="tocline"><a class="tocxref" href="#sparql-definition-lessThanOrEquals"><bdi class="secno">C.12 </bdi>sh:lessThanOrEquals</a></li><li class="tocline"><a class="tocxref" href="#sparql-definition-in"><bdi class="secno">C.13 </bdi>sh:in</a></li></ol></li><li class="tocline"><a class="tocxref" href="#security"><bdi class="secno">D. </bdi>Security and Privacy Considerations</a></li><li class="tocline"><a class="tocxref" href="#ack"><bdi class="secno">E. </bdi>Acknowledgements</a></li><li class="tocline"><a class="tocxref" href="#revision-history"><bdi class="secno">F. </bdi>Revision History</a></li><li class="tocline"><a class="tocxref" href="#changes-12"><bdi class="secno">G. </bdi>Changes between SHACL 1.0 SPARQL and SHACL 1.2 SPARQL Extensions</a></li><li class="tocline"><a class="tocxref" href="#references"><bdi class="secno">H. </bdi>References</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#normative-references"><bdi class="secno">H.1 </bdi>Normative references</a></li></ol></li></ol></nav>

		<section id="introduction"><div class="header-wrapper"><h2 id="x1-introduction"><bdi class="secno">1. </bdi>Introduction</h2><a class="self-link" href="#introduction" aria-label="Permalink for Section 1."></a></div>
			
			<p>
				This document specifies the SPARQL-related features of the SHACL (Shapes Constraint Language).
			</p>
			<section id="terminology"><div class="header-wrapper"><h3 id="x1-1-terminology"><bdi class="secno">1.1 </bdi>Terminology</h3><a class="self-link" href="#terminology" aria-label="Permalink for Section 1.1"></a></div>
				
				<p>
					Throughout this document, the following terminology is used.
				</p>
				<p>
					The SHACL SPARQL Extensions defined in this document are sometimes called SHACL-SPARQL.
				</p>
				<p>
					Terminology that is linked to portions of RDF 1.2 Concepts and Abstract Syntax is used in SHACL-SPARQL as defined there.
					Terminology that is linked to portions of SPARQL 1.2 Query Language is used in SHACL-SPARQL as defined there. 
					Terminology that is linked to portions of SHACL 1.2 Core is used in SHACL-SPARQL as defined there. 
					A single linkage is sufficient to provide a definition for all occurences of a particular term in this document.
				</p>
				<p>
					Definitions are complete within this document, i.e., if there is no rule to
					make some situation true in this document then the situation is false.
				</p>
				<div class="def" id="rdf-terminology">
					<div class="term-def-header">Basic RDF Terminology</div>
					<div>
						This document uses the terms 
						<dfn data-lt="graph|graphs|RDF graphs" id="dfn-graph" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/rdf12-concepts/#dfn-rdf-graph">RDF graph</a></dfn>,
						<dfn data-lt="triple|triples" id="dfn-triple" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/rdf12-concepts/#dfn-rdf-triple">RDF triple</a></dfn>,
						<dfn data-lt="IRI|IRIs" data-plurals="iris" id="dfn-iri" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRI</a></dfn>,
						<dfn data-lt="literal|literals" id="dfn-literal" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/rdf12-concepts/#dfn-literal">literal</a></dfn>,
						<dfn data-lt="blank node|blank nodes" id="dfn-blank-node" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/rdf12-concepts/#dfn-blank-node">blank node</a></dfn>,
						<dfn data-lt="node|nodes" id="dfn-node" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/rdf12-concepts/#dfn-node">node</a></dfn> of an RDF graph,
						<dfn data-lt="datatype|datatypes" id="dfn-datatype" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/rdf12-concepts/#dfn-datatype">datatype</a></dfn>,
						<dfn data-lt="term|terms" data-plurals="rdf terms" id="dfn-term" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/rdf12-concepts/#dfn-rdf-term">RDF term</a></dfn>, and
						<dfn data-lt="subject|subjects" id="dfn-subject" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/rdf12-concepts/#dfn-subject">subject</a></dfn>,
						<dfn data-lt="predicate|predicates" id="dfn-predicate" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/rdf12-concepts/#dfn-predicate">predicate</a></dfn>, and
						<dfn data-lt="object|objects" id="dfn-object" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/rdf12-concepts/#dfn-object">object</a></dfn> of RDF triples
						as defined in RDF 1.2 Concepts and Abstract Syntax [<cite><a class="bibref" data-link-type="biblio" href="#bib-rdf12-concepts" title="RDF 1.2 Concepts and Abstract Syntax">rdf12-concepts</a></cite>].
					</div>
				</div>
				<div class="def" id="shacl-terminology">
					<div class="term-def-header">Basic SHACL Terminology</div>
					<div>
						This document uses the terms
						<dfn data-lt="focus node|focus nodes" id="dfn-focus-node" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-focus-node">focus node</a></dfn>,
						<dfn data-lt="value" data-plurals="values" id="dfn-value" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a></dfn>,
						<dfn data-lt="value node|value nodes" id="dfn-value-node" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-value-node">value node</a></dfn>,
						<dfn data-lt="constraint|constraints" id="dfn-constraint" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-constraint">constraint</a></dfn>,
						<dfn data-lt="constraint component|constraint components" id="dfn-constraint-component" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-constraint-component">constraint component</a></dfn>,
						<dfn data-lt="parameter|parameters" id="dfn-parameter" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-parameter">parameter</a></dfn>,
						<dfn data-lt="mandatory parameter|mandatory parameters" id="dfn-mandatory-parameter" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-mandatory-parameter">mandatory parameter</a></dfn>,
						<dfn data-lt="optional parameter|optional parameters" id="dfn-optional-parameter" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-optional-parameter">optional parameter</a></dfn>,
						<dfn data-lt="parameter value" id="dfn-parameter-value" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-parameter-value">parameter value</a></dfn>,
						<dfn data-lt="shape|shapes" id="dfn-shape" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-shape">shape</a></dfn>,
						<dfn data-lt="node shape|node shapes" id="dfn-node-shape" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-node-shape">node shape</a></dfn>,
						<dfn data-lt="property shape|property shapes" id="dfn-property-shape" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-property-shape">property shape</a></dfn>,
						<dfn data-lt="shacl property path|shacl property paths" id="dfn-shacl-property-path" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-shacl-property-path">SHACL property path</a></dfn>,
						<dfn data-lt="sparql property path|sparql property paths" id="dfn-sparql-property-path" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-sparql-property-path">SPARQL property path</a></dfn>,
						<dfn data-lt="shapes graph" id="dfn-shapes-graph" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-shapes-graph">shapes graph</a></dfn>,
						<dfn data-lt="target|targets" id="dfn-target" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-target">target</a></dfn>,
						<dfn data-lt="validator|validators" id="dfn-validator" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-validators">validator</a></dfn>,
						<dfn data-lt="node expression|node expresssions" id="dfn-node-expression" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-node-expression">node expression</a></dfn>,
						<dfn data-lt="node expression function|node expresssion functions" data-plurals="node expression functions" id="dfn-node-expression-function" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-node-expression-function">node expression function</a></dfn>,
						<dfn data-lt="node expression function name" id="dfn-node-expression-function-name" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-function-name">function name</a></dfn>,
						<dfn data-lt="key parameter" id="dfn-key-parameter" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-key-parameter">key parameter</a></dfn>,
						<dfn data-lt="output nodes" id="dfn-output-nodes" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-output-nodes">output nodes</a></dfn>,
						<dfn data-lt="focus graph" id="dfn-focus-graph" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-focus-graph">focus graph</a></dfn>,
						<dfn data-lt="conform|conforms" id="dfn-conform" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-conform">conform</a></dfn>,
						<dfn data-lt="failure|failures" id="dfn-failure" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-failure">failure</a></dfn>,
						<dfn data-lt="shacl instance" data-plurals="shacl instances" id="dfn-shacl-instance" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-shacl-instance">SHACL instance</a></dfn>,
						<dfn data-lt="shacl subclass" id="dfn-shacl-subclass" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-shacl-subclass">SHACL subclass</a></dfn>,
						<dfn data-lt="shacl type" id="dfn-shacl-type" class="externalDFN" data-no-export="" data-dfn-type="dfn"><a href="https://www.w3.org/TR/shacl12-core/#dfn-shacl-type">SHACL type</a></dfn>,
						as defined in the SHACL 1.2 Core specification [<cite><a class="bibref" data-link-type="biblio" href="#bib-shacl12-core" title="SHACL 1.2 Core">shacl12-core</a></cite>].
					</div>
				</div>
				<div class="def">
					<div class="term-def-header">Binding, Solution</div>
					<div>
						A <dfn data-lt="bindings|binding" id="dfn-bindings" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">binding</dfn> is a pair (<a href="https://www.w3.org/TR/sparql12-query/#defn_QueryVariable">variable</a>, <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-rdf-term">RDF term</a>), consistent with the term's use in [<cite><a class="bibref" data-link-type="biblio" href="#bib-sparql12-query" title="SPARQL 1.2 Query Language">sparql12-query</a></cite>].
					    A <dfn data-lt="solutions|solution" id="dfn-solutions" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">solution</dfn> is a set of bindings, informally often understood as one row in the body of the result table of a SPARQL query.
					    Variables are not required to be bound in a solution.
					</div>
				</div>

			</section>

			<section id="conventions"><div class="header-wrapper"><h3 id="x1-2-document-conventions"><bdi class="secno">1.2 </bdi>Document Conventions</h3><a class="self-link" href="#conventions" aria-label="Permalink for Section 1.2"></a></div>
				
				<p>
					The syntax of SHACL is RDF.
					The examples in this document use Turtle [<cite><a class="bibref" data-link-type="biblio" href="#bib-rdf12-turtle" title="RDF 1.2 Turtle">rdf12-turtle</a></cite>].
					Other RDF serializations such as RDF/XML may be used in practice.
					The reader should be familiar with basic RDF concepts [<cite><a class="bibref" data-link-type="biblio" href="#bib-rdf12-concepts" title="RDF 1.2 Concepts and Abstract Syntax">rdf12-concepts</a></cite>] such as triples and with SPARQL [<cite><a class="bibref" data-link-type="biblio" href="#bib-sparql12-query" title="SPARQL 1.2 Query Language">sparql12-query</a></cite>].
				</p>
				<p>
					Within this document, the following namespace prefix bindings are used:
				</p>
				<table class="term-table">
					<tbody><tr>
						<th>Prefix</th>
						<th>Namespace</th>
					</tr>
					<tr>
						<td><code>owl:</code></td>
						<td><code>http://www.w3.org/2002/07/owl#</code></td>
					</tr>
					<tr>
						<td><code>rdf:</code></td>
						<td><code>http://www.w3.org/1999/02/22-rdf-syntax-ns#</code></td>
					</tr>
					<tr>
						<td><code>rdfs:</code></td>
						<td><code>http://www.w3.org/2000/01/rdf-schema#</code></td>
					</tr>
					<tr>
						<td><code>sh:</code></td>
						<td><code><a href="https://www.w3.org/ns/shacl">http://www.w3.org/ns/shacl#</a></code></td>
					</tr>
					<tr>
						<td><code>xsd:</code></td>
						<td><code>http://www.w3.org/2001/XMLSchema#</code></td>
					</tr>
					<tr>
						<td><code>ex:</code></td>
						<td><code>http://example.com/ns#</code></td>
					</tr>
				</tbody></table>

				<p>
					Within this document, the following JSON-LD context is used:
				</p>
				<pre class="jsonld" aria-busy="false"><code class="hljs">{
  "@context": {
    "owl": "http://www.w3.org/2002/07/owl#",
    "rdf": "http://www.w3.org/1999/02/22-rdf-syntax-ns#",
    "rdfs": "http://www.w3.org/2000/01/rdf-schema#",
    "sh": "http://www.w3.org/ns/shacl#",
    "xsd": "http://www.w3.org/2001/XMLSchema#",
    "ex": "http://example.com/ns#"
  }
}</code></pre>
				<p>
					Note that the URI of the graph defining the SHACL vocabulary itself is equivalent to
					the namespace above, i.e. it includes the <code>#</code>.
					References to the SHACL vocabulary, e.g. via <code>owl:imports</code> should include the <code>#</code>.
				</p>
				<p>
					Throughout the document, color-coded boxes containing RDF graphs in Turtle will appear.
					These fragments of Turtle documents use the prefix bindings given above.
				</p>
				<div class="shapes-graph">
					
					
				<aside class="ds-selector-tabs"><div class="selectors">
						<button class="selected" data-selects="turtle">Turtle</button>
						<button data-selects="jsonld">JSON-LD</button>
					</div><div class="turtle selected tab">
# This box represents an input shapes graph

# Triples that can be omitted are marked as grey e.g.
<span class="triple-can-be-skipped">&lt;s&gt; ex:p &lt;o&gt; .</span>
					</div><div class="jsonld tab">
						<pre class="text" aria-busy="false"><code class="hljs">// This box represents an input shapes graph</code></pre>
						<pre class="jsonld" aria-busy="false"><code class="hljs">{
	"@id": "s",
	"ex:p": {
		"@id": "o"
	}
}</code></pre>
					</div></aside></div>

				<div class="data-graph">
					
					
				<aside class="ds-selector-tabs"><div class="selectors">
						<button class="selected" data-selects="turtle">Turtle</button>
						<button data-selects="jsonld">JSON-LD</button>
					</div><div class="turtle selected tab">
# This box represents an input data graph.
# When highlighting is used in the examples:

# Elements highlighted in blue are <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-focus-node">focus nodes</a>
<span class="focus-node-selected">ex:Bob</span> a ex:Person .

# Elements highlighted in red are focus nodes that fail validation
<span class="focus-node-error">ex:Alice</span> a ex:Person .
					</div><div class="jsonld tab">
						<pre class="jsonld" aria-busy="false"><code class="hljs">{
	"@graph": [
		{
			"@id": "ex:Alice",
			"@type": "ex:Person"
		},
		{
			"@id": "ex:Bob",
			"@type": "ex:Person"
		}
	]
}</code></pre>
					</div></aside></div>

				<div class="results-graph">
					
					
				<aside class="ds-selector-tabs"><div class="selectors">
						<button class="selected" data-selects="turtle">Turtle</button>
						<button data-selects="jsonld">JSON-LD</button>
					</div><div class="turtle selected tab">
# This box represents an output results graph
					</div><div class="jsonld tab">
						<pre class="text" aria-busy="false"><code class="hljs">// This box represents an output results graph</code></pre>
						<pre class="jsonld" aria-busy="false"><code class="hljs">{}</code></pre>
					</div></aside></div>

				<p>
					SHACL Definitions appear in blue boxes:
				</p>
				<div class="def def-sparql">
					<div class="def-header">SPARQL or TEXTUAL DEFINITIONS</div>
<pre class="def-sparql-body" aria-busy="false"><code class="hljs"># This box contains SPARQL or textual definitions.</code></pre>
				</div>
				
				<p class="syntax">
					Grey boxes such as this include syntax rules that apply to the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shapes-graph">shapes graph</a>.
				</p>

				<p>
					SPARQL variables using the <code>$</code> marker represent external <a href="#dfn-bindings" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-bindings-1">bindings</a> that are <a href="#dfn-pre-binding" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-pre-binding-1">pre-bound</a> or, in the case of <code>$PATH</code>, <a href="#dfn-substituted" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-substituted-1">substituted</a> in the SPARQL query before execution (as explained in <a href="#constraint-components-validation" class="sec-ref"><bdi class="secno">3.3 </bdi>Validation with SPARQL-based Constraint Components</a>).
				</p>
				
				<p>
					<code>true</code> denotes the RDF term <code>"true"^^xsd:boolean</code>.
					<code>false</code> denotes the RDF term <code>"false"^^xsd:boolean</code>.
				</p>

			</section>

			<section id="conformance"><div class="header-wrapper"><h3 id="x1-3-conformance"><bdi class="secno">1.3 </bdi>Conformance</h3><a class="self-link" href="#conformance" aria-label="Permalink for Section 1.3"></a></div><p>As well as sections marked as non-normative, all authoring guidelines, diagrams, examples, and notes in this specification are non-normative. Everything else in this specification is normative.</p><p>
        The key words <em class="rfc2119">MAY</em>, <em class="rfc2119">MUST</em>, and <em class="rfc2119">SHOULD</em> in this document
        are to be interpreted as described in
        <a href="https://www.rfc-editor.org/info/bcp14">BCP 14</a>
        [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">RFC2119</a></cite>] [<cite><a class="bibref" data-link-type="biblio" href="#bib-rfc8174" title="Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words">RFC8174</a></cite>]
        when, and only when, they appear in all
        capitals, as shown here.
      </p>
				<p>
					This document defines the <strong>SHACL-SPARQL</strong> language that extends SHACL Core.
					This specification describes conformance criteria for:
				</p>
				<ul>
					<li><strong>SHACL-SPARQL processors</strong> as processors that support validation with the SHACL-SPARQL Language</li>
				</ul>
				<p>
					This document includes syntactic rules that shapes and other nodes need to fulfill in the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shapes-graph">shapes graph</a>.
					These rules are typically of the form <em>A shape must have...</em> or <em>The values of X are literals</em> or <em>All objects of triples with predicate P must be IRIs</em>.
					The complete list of these rules can be found in the <a href="#syntax-rules">appendix</a>.
					Nodes that violate any of these rules are called <dfn id="dfn-ill-formed" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">ill-formed</dfn>.
					Nodes that violate none of these rules are called <dfn id="dfn-well-formed" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">well-formed</dfn>.
					A <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shapes-graph">shapes graph</a> is ill-formed if it contains at least one ill-formed node.
				</p>
			</section>
			
		</section>
		
		<section id="sparql-constraints"><div class="header-wrapper"><h2 id="x2-sparql-based-constraints"><bdi class="secno">2. </bdi>SPARQL-based Constraints</h2><a class="self-link" href="#sparql-constraints" aria-label="Permalink for Section 2."></a></div>
			
			<p>
				SHACL-SPARQL supports a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-constraint-component">constraint component</a> that can be used to express restrictions based on a SPARQL SELECT query.
			</p>
			<p>
				<span class="component-class">Constraint Component IRI</span>: <code>sh:SPARQLConstraintComponent</code>
			</p>

			<div class="parameters">Parameters:</div>
			<table class="term-table">
				<tbody><tr>
					<th>Property</th>
					<th>Summary</th>
				</tr>
				<tr>
					<td><code>sh:sparql</code></td>
					<td>A <a href="#dfn-sparql-based-constraint" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-1">SPARQL-based constraint</a> declaring the SPARQL query to evaluate.</td>
				</tr>
			</tbody></table>
			<p>
				The <a href="#sparql-constraints-syntax">syntax rules</a> and <a href="#sparql-constraints-validation">validation process</a> for SPARQL-based constraints are defined in the rest of this section.
			</p>

			<section id="sparql-constraints-example" class="informative"><div class="header-wrapper"><h3 id="x2-1-an-example-sparql-based-constraint"><bdi class="secno">2.1 </bdi>An Example SPARQL-based Constraint</h3><a class="self-link" href="#sparql-constraints-example" aria-label="Permalink for Section 2.1"></a></div><p><em>This section is non-normative.</em></p>
				
				<p>
					The following example illustrates the syntax of a <a href="#dfn-sparql-based-constraint" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-2">SPARQL-based constraint</a>.
				</p>

				<aside class="example" id="example-sparql-constraint"><div class="marker">
    <a class="self-link" href="#example-sparql-constraint">Example<bdi> 1</bdi></a><span class="example-title">: A SPARQL-based constraint</span>
  </div>
					<div class="shapes-graph">
						
						
					<aside class="ds-selector-tabs"><div class="selectors">
						<button class="selected" data-selects="turtle">Turtle</button>
						<button data-selects="jsonld">JSON-LD</button>
					</div><div class="turtle selected tab">
ex:LanguageExampleShape
	a sh:NodeShape ;
	<span class="target-can-be-skipped">sh:targetClass ex:Country ;</span>
	sh:sparql [
		a sh:SPARQLConstraint ;   # This triple is optional
		sh:message "Values are literals with German language tag." ;
		sh:prefixes ex: ;
		sh:select """
			SELECT $this (ex:germanLabel AS ?path) ?value
			WHERE {
				$this ex:germanLabel ?value .
				FILTER (!isLiteral(?value) || !langMatches(lang(?value), "de"))
			}
			""" ;
	] .

ex:
	sh:declare [] .   # See <a href="#prefixes-example">prefix declarations</a>
						</div><div class="jsonld tab">
							<pre class="jsonld" aria-busy="false"><code class="hljs">{
	"@graph": [
		{
			"@id": "ex:LanguageExampleShape",
			"@type": "sh:NodeShape",
			"sh:sparql": {
				"@type": "sh:SPARQLConstraint",
				"sh:message": "Values are literals with German language tag.",
				"sh:prefixes": {
					"@id": "http://example.com/ns#"
				},
				"sh:select": "\n\t\t\tSELECT $this (ex:germanLabel AS ?path) ?value\n\t\t\tWHERE {\n\t\t\t\t$this ex:germanLabel ?value .\n\t\t\t\tFILTER (!isLiteral(?value) || !langMatches(lang(?value), \"de\"))\n\t\t\t}\n\t\t\t"
			},
			"sh:targetClass": {
				"@id": "ex:Country"
			}
		},
		{
			"@id": "http://example.com/ns#",
			"sh:declare": {
				"@id": "_:b1"
			}
		}
	]
}</code></pre>
						</div></aside></div>
					<p>
						The target of the shape above includes all <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shacl-instance">SHACL instances</a> of <code>ex:Country</code>.
						For those nodes (represented by the variable <code>this</code>), the SPARQL query walks through the values of <code>ex:germanLabel</code>
						and verifies that they are literals with a German language code.
					</p>
					<div class="data-graph">
						
						
					<aside class="ds-selector-tabs"><div class="selectors">
						<button class="selected" data-selects="turtle">Turtle</button>
						<button data-selects="jsonld">JSON-LD</button>
					</div><div class="turtle selected tab">
ex:ValidCountry a ex:Country ;
	ex:germanLabel "Spanien"@de .
	  
<span class="focus-node-error">ex:InvalidCountry</span> a ex:Country ;
	ex:germanLabel "Spain"@en .
						</div><div class="jsonld tab">
							<pre class="jsonld" aria-busy="false"><code class="hljs">{
	"@graph": [
		{
			"@id": "ex:InvalidCountry",
			"@type": "ex:Country",
			"ex:germanLabel": {
				"@language": "en",
				"@value": "Spain"
			}
		},
		{
			"@id": "ex:ValidCountry",
			"@type": "ex:Country",
			"ex:germanLabel": {
				"@language": "de",
				"@value": "Spanien"
			}
		}
	]
}</code></pre>
						</div></aside></div>
	
					<div class="results-graph">
						
						
					<aside class="ds-selector-tabs"><div class="selectors">
						<button class="selected" data-selects="turtle">Turtle</button>
						<button data-selects="jsonld">JSON-LD</button>
					</div><div class="turtle selected tab">
[	a sh:ValidationReport ;
	sh:conforms false ;
	sh:result [
		a sh:ValidationResult ;
		sh:resultSeverity sh:Violation ;
		sh:focusNode ex:InvalidCountry ;
		sh:resultPath ex:germanLabel ;
		sh:value "Spain"@en ;
		sh:sourceConstraintComponent sh:SPARQLConstraintComponent ;
		sh:sourceShape ex:LanguageExampleShape ;
		# ...
	]
] .
						</div><div class="jsonld tab">
							<pre class="jsonld" aria-busy="false"><code class="hljs">{
	"@type": "sh:ValidationReport",
	"sh:conforms": {
		"@type": "xsd:boolean",
		"@value": "false"
	},
	"sh:result": {
		"@type": "sh:ValidationResult",
		"sh:focusNode": {
			"@id": "ex:InvalidCountry"
		},
		"sh:resultPath": {
			"@id": "ex:germanLabel"
		},
		"sh:resultSeverity": {
			"@id": "sh:Violation"
		},
		"sh:sourceConstraintComponent": {
			"@id": "sh:SPARQLConstraintComponent"
		},
		"sh:sourceShape": {
			"@id": "ex:LanguageExampleShape"
		},
		"sh:value": {
			"@language": "en",
			"@value": "Spain"
		}
	}
}</code></pre>
						</div></aside></div>
				</aside>
				<p>
					The SPARQL query returns result set <a href="#dfn-solutions" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-solutions-1">solutions</a> for all bindings of the variable <code>value</code> that violate the constraint.
					There is a validation result for each <a href="#dfn-solutions" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-solutions-2">solution</a> in that result set, applying the <a href="#sparql-constraints-validation">mapping rules</a> explained later.
					In this example, each validation result will have the <a href="#dfn-bindings" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-bindings-2">binding</a> for the variable <code>this</code> as the <code>sh:focusNode</code>,
					<code>ex:germanLabel</code> as <code>sh:resultPath</code> and the violating value as <code>sh:value</code>.
				</p>
				<p>
					The following example illustrates a similar scenario as above, but with a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-property-shape">property shape</a>.
				</p>
				<aside class="example" id="example-sparql-constraint-in-property-shape"><div class="marker">
    <a class="self-link" href="#example-sparql-constraint-in-property-shape">Example<bdi> 2</bdi></a>
  </div>
					<div class="shapes-graph">
						
						
					<aside class="ds-selector-tabs"><div class="selectors">
						<button class="selected" data-selects="turtle">Turtle</button>
						<button data-selects="jsonld">JSON-LD</button>
					</div><div class="turtle selected tab">
ex:LanguageExamplePropertyShape
	a sh:PropertyShape ;
	<span class="target-can-be-skipped">sh:targetClass ex:Country ;</span>
	sh:path ex:germanLabel ;
	sh:sparql [
		a sh:SPARQLConstraint ;   # This triple is optional
		sh:message "Values are literals with German language tag." ;
		sh:prefixes ex: ;
		sh:select """
			SELECT $this ?value
			WHERE {
				$this $PATH ?value .
				FILTER (!isLiteral(?value) || !langMatches(lang(?value), "de"))
			}
			""" ;
	] .

ex:
	sh:declare [] .   # See <a href="#prefixes-example">prefix declarations</a>
						</div><div class="jsonld tab">
							<pre class="jsonld" aria-busy="false"><code class="hljs">{
	"@graph": [
		{
			"@id": "ex:LanguageExamplePropertyShape",
			"@type": "sh:PropertyShape",
			"sh:path": {
				"@id": "ex:germanLabel"
			},
			"sh:sparql": {
				"@type": "sh:SPARQLConstraint",
				"sh:message": "Values are literals with German language tag.",
				"sh:prefixes": {
					"@id": "http://example.com/ns#"
				},
				"sh:select": "\n\t\t\tSELECT $this ?value\n\t\t\tWHERE {\n\t\t\t\t$this $PATH ?value .\n\t\t\t\tFILTER (!isLiteral(?value) || !langMatches(lang(?value), \"de\"))\n\t\t\t}\n\t\t\t"
			},
			"sh:targetClass": {
				"@id": "ex:Country"
			}
		},
		{
			"@id": "http://example.com/ns#",
			"sh:declare": {
				"@id": "_:b1"
			}
		}
	]
}</code></pre>
						</div></aside></div>
				</aside>
			</section>
			
			<section id="sparql-constraints-syntax"><div class="header-wrapper"><h3 id="x2-2-syntax-of-sparql-based-constraints"><bdi class="secno">2.2 </bdi>Syntax of SPARQL-based Constraints</h3><a class="self-link" href="#sparql-constraints-syntax" aria-label="Permalink for Section 2.2"></a></div>
				
				<p class="syntax">
					<span data-syntax-rule="sparql-nodeKind" id="syntax-rule-sparql-nodeKind">Shapes may have values for the property <code>sh:sparql</code>, and these values are either <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRIs</a> or <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-blank-node">blank nodes</a>.</span>
					These values are called <dfn data-lt="SPARQL-based constraint|SPARQL-based constraints" data-plurals="sparql-based constraint" id="dfn-sparql-based-constraint" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">SPARQL-based constraints</dfn>.
				</p>
				<p class="syntax">
					<span data-syntax-rule="SPARQLConstraint-select-count" id="syntax-rule-SPARQLConstraint-select-count"><a href="#dfn-sparql-based-constraint" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-3">SPARQL-based constraints</a> have exactly one <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> for the property <code>sh:select</code></span>.
					<span data-syntax-rule="SPARQLConstraint-select-datatype" id="syntax-rule-SPARQLConstraint-select-datatype">The value of <code>sh:select</code> is a <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-literal">literal</a> of datatype <code>xsd:string</code>.</span>
					The class <code>sh:SPARQLConstraint</code> is defined in the SHACL vocabulary and may be used as the <a data-link-type="dfn" href="https://www.w3.org/TR/vc-data-model/#dfn-type">type</a> of these constraints (although no type is required).
					<span data-syntax-rule="select-query-valid" id="syntax-rule-select-query-valid">Using the <a href="#sparql-prefixes">prefix handling rules</a>, the value of <code>sh:select</code> is a valid SPARQL 1.2 SELECT query.</span>
					<span data-syntax-rule="select-query-this" id="syntax-rule-select-query-this">The SPARQL query derived from the value of <code>sh:select</code> <a href="https://www.w3.org/TR/sparql12-query/#selectproject">projects</a> the variable <code>this</code> in the SELECT clause.</span>
				</p>
				<p>
					The following two properties are similar to their use in <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shape">shapes</a>:
				</p>
				<p class="syntax">
					<span data-syntax-rule="SPARQLConstraint-message-datatype" id="syntax-rule-SPARQLConstraint-message-datatype"><a href="#dfn-sparql-based-constraint" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-4">SPARQL-based constraints</a> may have values for the property <code>sh:message</code> and these are either <code>xsd:string</code> literals or literals with a language tag.</span>
					<span data-syntax-rule="SPARQLConstraint-deactivated-maxCount" id="syntax-rule-SPARQLConstraint-deactivated-maxCount"><a href="#dfn-sparql-based-constraint" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-5">SPARQL-based constraints</a> may have at most one value for the property <code>sh:deactivated</code></span>
					and this value is either <code>true</code> or <code>false</code>.
				</p>
				<p>
					SELECT queries used in the context of <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-property-shape">property shapes</a> use a special variable named <code>PATH</code> as a placeholder for the path used by the shape.
				</p>
				<p class="syntax">
					<span data-syntax-rule="PATH-position" id="syntax-rule-PATH-position">The only legal use of the variable <code>PATH</code> in the SPARQL queries of <a href="#dfn-sparql-based-constraint" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-6">SPARQL-based constraints</a>
					and <a href="#dfn-select-based-validators" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-select-based-validators-1">SELECT-based validators</a> is in the
					<a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-predicate">predicate</a> position of a <a href="https://www.w3.org/TR/sparql12-query/#QSynTriples">triple pattern</a>.</span>
					A query that uses the variable <code>PATH</code> in any other position is <a href="#dfn-ill-formed" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-ill-formed-1">ill-formed</a>.
				</p>
				<section id="sparql-prefixes"><div class="header-wrapper"><h4 id="x2-2-1-prefix-declarations-for-sparql-queries"><bdi class="secno">2.2.1 </bdi>Prefix Declarations for SPARQL Queries</h4><a class="self-link" href="#sparql-prefixes" aria-label="Permalink for Section 2.2.1"></a></div>
					
					<p>
						A <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shapes-graph">shapes graph</a> may include declarations of namespace prefixes so that these prefixes can be used to abbreviate the SPARQL queries derived from the same shapes graph.
						The syntax of such prefix declarations is illustrated by the following example.
					</p>
					<aside class="example" id="prefixes-example"><div class="marker">
    <a class="self-link" href="#prefixes-example">Example<bdi> 3</bdi></a>
  </div>
						<div class="shapes-graph">
							
							
						<aside class="ds-selector-tabs"><div class="selectors">
						<button class="selected" data-selects="turtle">Turtle</button>
						<button data-selects="jsonld">JSON-LD</button>
					</div><div class="turtle selected tab">
ex:
	sh:declare [
		sh:prefix "ex" ;
		sh:namespace "http://example.com/ns#"^^xsd:anyURI ;
	] ;
	sh:declare [
		sh:prefix "schema" ;
		sh:namespace "http://schema.org/"^^xsd:anyURI ;
	] ;
	a owl:Ontology ;    # Optional
	owl:imports sh: .   # Optional
							</div><div class="jsonld tab">
								<pre class="jsonld" aria-busy="false"><code class="hljs">{
	"@id": "http://example.com/ns#",
	"@type": "owl:Ontology",
	"owl:imports": {
		"@id": "http://www.w3.org/ns/shacl#"
	},
	"sh:declare": [
		{
			"sh:namespace": {
				"@type": "xsd:anyURI",
				"@value": "http://example.com/ns#"
			},
			"sh:prefix": "ex"
		},
		{
			"sh:namespace": {
				"@type": "xsd:anyURI",
				"@value": "http://schema.org/"
			},
			"sh:prefix": "schema"
		}
	]
}</code></pre>
							</div></aside></div>
					</aside>
					<p class="syntax">
						<span data-syntax-rule="declare-nodeKind" id="syntax-rule-declare-nodeKind">The <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">values</a> of the property <code>sh:declare</code> are <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRIs</a> or <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-blank-node">blank nodes</a></span>,
						and these values are called <dfn data-lt="prefix declaration|prefix declarations" id="dfn-prefix-declaration" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">prefix declarations</dfn>.
						The SHACL vocabulary includes the class <code>sh:PrefixDeclaration</code> as type for such <a href="#dfn-prefix-declaration" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-prefix-declaration-1">prefix declarations</a>
						although no <code>rdf:type</code> triple is required for them.
						<span data-syntax-rule="prefix-count" id="syntax-rule-prefix-count"><a href="#dfn-prefix-declaration" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-prefix-declaration-2">Prefix declarations</a> have exactly one value for the property <code>sh:prefix</code></span>.
						<span data-syntax-rule="prefix-datatype" id="syntax-rule-prefix-datatype">The values of <code>sh:prefix</code> are <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-literal">literals</a> of datatype <code>xsd:string</code>.</span>
						<span data-syntax-rule="namespace-count" id="syntax-rule-namespace-count"><a href="#dfn-prefix-declaration" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-prefix-declaration-3">Prefix declarations</a> have exactly one value for the property <code>sh:namespace</code>.</span>
						<span data-syntax-rule="namespace-datatype" id="syntax-rule-namespace-datatype">The values of <code>sh:namespace</code> are <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-literal">literals</a> of datatype <code>xsd:anyURI</code>.</span>
						Such a pair of values specifies a single mapping of a prefix to a namespace.
					</p>
					<p>
						The recommended <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-subject">subject</a> for values of <code>sh:declare</code> is the IRI of the named graph containing the shapes that use the prefixes.
						These IRIs are often declared as an instance of <code>owl:Ontology</code>, but this is not required.
					</p>
					<p>
						<a href="#dfn-prefix-declaration" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-prefix-declaration-4">Prefix declarations</a> can be used by <a href="#dfn-sparql-based-constraint" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-7">SPARQL-based constraints</a>,
						the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-validators">validators</a> of <a href="#sparql-constraint-components">SPARQL-based constraint components</a>,
						and by similar features defined by SHACL extensions.
						These nodes can use the property <code>sh:prefixes</code> to specify a set of prefix mappings.
						An example use of the <code>sh:prefixes</code> property can be found in the
						<a href="#sparql-constraints-example">example</a> above.
					</p>
					<p class="syntax">
						<span data-syntax-rule="prefixes-nodeKind" id="syntax-rule-prefixes-nodeKind">The values of <code>sh:prefixes</code> are either <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRIs</a> or <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-blank-node">blank nodes</a>.</span>
						<span data-syntax-rule="prefixes-duplicates" id="syntax-rule-prefixes-duplicates">A SHACL processor collects a set of prefix mappings as the union of all
						individual prefix mappings that are <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">values</a> of the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-sparql-property-path">SPARQL property path</a> <code>sh:prefixes/owl:imports*/sh:declare</code>
						of the <a href="#dfn-sparql-based-constraint" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-8">SPARQL-based constraint</a> or <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-validators">validator</a>.
						If such a collection of prefix declarations contains multiple different namespaces for the same <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> of <code>sh:prefix</code>,
						then the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shapes-graph">shapes graph</a> is <a href="#dfn-ill-formed" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-ill-formed-2">ill-formed</a>.</span>
						(Note that SHACL processors <em class="rfc2119">MAY</em> ignore prefix declarations that are never reached).
					</p>
					<p>
						A SHACL processor transforms the values of <code>sh:select</code> (and similar properties such as <code>sh:ask</code>)
						into SPARQL by prepending <a href="https://www.w3.org/TR/sparql12-query/#rPrefixDecl"><code>PREFIX</code></a> declarations
						for all prefix mappings.
						Each value of <code>sh:prefix</code> is turned into the <code>PNAME_NS</code>, while each value of <code>sh:namespace</code> is turned
						into the <code>IRIREF</code> in the <code>PREFIX</code> declaration.
						For the example shapes graph above, a SHACL-SPARQL processor would produce lines such as <code>PREFIX ex: &lt;http://example.com/ns#&gt;</code>.
						The SHACL-SPARQL processor <em class="rfc2119">MUST</em> produce a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-failure">failure</a> if the resulting query string cannot be parsed into a valid SPARQL 1.2 query.
					</p>
					<p>
						In the rest of this document, the <code>sh:prefixes</code> statements may have been omitted for brevity.
					</p>
				</section>
			</section>
			<section id="sparql-constraints-validation"><div class="header-wrapper"><h3 id="x2-3-validation-with-sparql-based-constraints"><bdi class="secno">2.3 </bdi>Validation with SPARQL-based Constraints</h3><a class="self-link" href="#sparql-constraints-validation" aria-label="Permalink for Section 2.3"></a></div>
				
				<p>
					This section explains the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-validators">validator</a> of <code>sh:SPARQLConstraintComponent</code>.
					Note that this validator only explains one possible implementation strategy, and
					SHACL processors may choose alternative approaches as long as the outcome is equivalent.
				</p>
				<div class="def def-text">
					<div class="def-header">TEXTUAL DEFINITION</div>
					<div class="def-text-body">
						Let <code>$sparql</code> be a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> of <code>sh:sparql</code>.
						There are no validation results if the <a href="#dfn-sparql-based-constraint" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-9">SPARQL-based constraint</a> has <code>true</code>
						as a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> for the property <code>sh:deactivated</code>.
						Otherwise, execute the SPARQL query specified by the <a href="#dfn-sparql-based-constraint" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-10">SPARQL-based constraint</a> <code>$sparql</code>
						<a href="#dfn-pre-binding" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-pre-binding-2">pre-binding</a> the variables <code>this</code> and, if supported,
						<code>shapesGraph</code> and <code>currentShape</code> as described in <a href="#sparql-constraints-prebound" class="sec-ref"><bdi class="secno">2.3.1 </bdi>Pre-bound Variables in SPARQL Constraints ($this, $shapesGraph, $currentShape)</a>. 
						If the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shape">shape</a> is a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-property-shape">property shape</a>, then prior to execution
						<dfn data-lt="substituted|substitute" id="dfn-substituted" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">substitute</dfn> the variable <code>PATH</code> where it appears in the <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-predicate">predicate</a>
						position of a <a href="https://www.w3.org/TR/sparql12-query/#QSynTriples">triple pattern</a>
						with a valid SPARQL surface syntax string of the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shacl-property-path">SHACL property path</a>
						specified via <code>sh:path</code> at the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-property-shape">property shape</a>.
						<span id="sparql-constraints-validation-rule">There is one validation result for each <a href="#dfn-solutions" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-solutions-3">solution</a> that does not have <code>true</code> as the <a href="#dfn-bindings" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-bindings-3">binding</a> for the variable <code>failure</code>.
						These validation results <em class="rfc2119">MUST</em> have the property values explained in <a href="#sparql-constraints-variables" class="sec-ref"><bdi class="secno">2.3.2 </bdi>Mapping of Solution Bindings to Result Properties</a>.
						A <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-failure">failure</a> <em class="rfc2119">MUST</em> be produced if and only if one of the <a href="#dfn-solutions" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-solutions-4">solutions</a> has <code>true</code> as the <a href="#dfn-bindings" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-bindings-4">binding</a> for <code>failure</code>.</span>
					</div>
				</div>
				<section id="sparql-constraints-prebound"><div class="header-wrapper"><h4 id="x2-3-1-pre-bound-variables-in-sparql-constraints-this-shapesgraph-currentshape"><bdi class="secno">2.3.1 </bdi>Pre-bound Variables in SPARQL Constraints ($this, $shapesGraph, $currentShape)</h4><a class="self-link" href="#sparql-constraints-prebound" aria-label="Permalink for Section 2.3.1"></a></div>
					
					<p>
						When the SPARQL queries of <a href="#dfn-sparql-based-constraint" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-11">SPARQL-based constraints</a> and the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-validators">validators</a>
						of <a href="#dfn-sparql-based-constraint-components" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-components-1">SPARQL-based constraint components</a> are <a href="https://www.w3.org/TR/shacl12-core/#validation-definition">processed</a>,
						the SHACL-SPARQL processor <a href="#dfn-pre-binding" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-pre-binding-3">pre-binds</a> values for the variables in the following table.
					</p>
					<table class="term-table">
						<tbody><tr>
							<th>Variable</th>
							<th>Interpretation</th>
						</tr>
						<tr>
							<td><code>this</code></td>
							<td>
								The <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-focus-node">focus node</a>.
							</td>
						</tr>
						<tr>
							<td><code style="white-space: nowrap">shapesGraph</code> (Optional)</td>
							<td>
								Can be used to query the shapes graph as in <code>GRAPH $shapesGraph { ... }</code>.
								If the shapes graph is a named graph in the same dataset as the data graph then it is the <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRI</a> of the shapes graph in the dataset.
								Not all SHACL-SPARQL processors need to support this variable.
								Processors that do not support the variable <code>shapesGraph</code> <em class="rfc2119">MUST</em> report a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-failure">failure</a> if they encounter a query that references this variable.
								Use of <code>GRAPH $shapesGraph { ... }</code> should be handled with extreme caution.
								It may result in constraints that are not interoperable across different SHACL-SPARQL processors and that may not run on remote RDF datasets.
							</td>
						</tr>
						<tr>
							<td><code style="white-space: nowrap">currentShape</code> (Optional)</td>
							<td>
								The current <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shape">shape</a>.  Typically used in conjunction with the variable <code>shapesGraph</code>.
								The same support policies as for <code>shapesGraph</code> apply for this variable.
							</td>
						</tr>
					</tbody></table>
				</section>
				<section id="sparql-constraints-variables"><div class="header-wrapper"><h4 id="x2-3-2-mapping-of-solution-bindings-to-result-properties"><bdi class="secno">2.3.2 </bdi>Mapping of Solution Bindings to Result Properties</h4><a class="self-link" href="#sparql-constraints-variables" aria-label="Permalink for Section 2.3.2"></a></div>
					
					<p>
						The property <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">values</a> of the validation result nodes are derived by the following rules, through a combination of result solutions and the values of the constraint itself.
						The rules are meant to be executed from top to bottom, so that the first bound value will be used.
					</p>
					<table class="term-table">
						<tbody><tr>
							<th>Property</th>
							<th>Production Rules</th>
						</tr>
						<tr>
							<td><code>sh:focusNode</code></td>
							<td>
								<ol>
									<li>The binding for the variable <code>this</code></li>
								</ol>
							</td>
						</tr>
						<tr>
							<td><code>sh:resultPath</code></td>
							<td>
								<ol>
									<li>The binding for the variable <code>path</code>, if that is a <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRI</a></li>
									<li>For results produced by a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-property-shape">property shape</a>, a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shacl-property-path">SHACL property path</a> that is equivalent to the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> of <code>sh:path</code> of the shape</li>
								</ol>
							</td>
						</tr>
						<tr>
							<td><code>sh:value</code></td>
							<td>
								<ol>
									<li>The binding for the variable <code>value</code></li>
									<li>The <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value-node">value node</a></li>
								</ol>
							</td>
						</tr>
						<tr>
							<td><code>sh:resultMessage</code></td>
							<td>
								<ol>
									<li>The binding for the variable <code>message</code></li>
									<li>
										For SPARQL-based constraints: The values of <code>sh:message</code> of the <a href="#dfn-sparql-based-constraint" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-12">SPARQL-based constraint</a>.
										For SPARQL-based constraint components: The values of <code>sh:message</code> of the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-validators">validator</a> of the <a href="#dfn-sparql-based-constraint-components" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-components-2">SPARQL-based constraint component</a>.
									</li>
									<li>
										For SPARQL-based constraint components: The values of <code>sh:message</code> of the <a href="#dfn-sparql-based-constraint-components" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-components-3">SPARQL-based constraint component</a>.
									</li>
								</ol>
								<div>
									These message literals may include the names of any SELECT result variables via <code>{?varName}</code> or <code>{$varName}</code>.
									If the constraint is based on a <a href="#sparql-constraint-components">SPARQL-based constraint component</a>, then the component's <a href="#dfn-parameter-names" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-parameter-names-1">parameter names</a> can also be used.
									These <code>{?varName}</code> and <code>{$varName}</code> blocks <em class="rfc2119">SHOULD</em> be replaced with suitable string representations of the values of said variables.
								</div>
							</td>
						</tr>
						<tr>
							<td><code>sh:sourceConstraint</code></td>
							<td>
								<ol>
									<li>The <a href="#dfn-sparql-based-constraint" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-13">SPARQL-based constraint</a>, i.e. the value of <code>sh:sparql</code></li>
								</ol>
							</td>
						</tr>
					</tbody></table>
				</section>
			</section>
		</section>
		
		<section id="sparql-constraint-components"><div class="header-wrapper"><h2 id="x3-sparql-based-constraint-components"><bdi class="secno">3. </bdi>SPARQL-based Constraint Components</h2><a class="self-link" href="#sparql-constraint-components" aria-label="Permalink for Section 3."></a></div>
			
			<p>
				<a href="#dfn-sparql-based-constraint" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-14">SPARQL-based constraints</a> provide a lot of flexibility
				but may be hard to understand for some people or lead to repetition.
				This section introduces <a href="#dfn-sparql-based-constraint-components" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-components-4">SPARQL-based constraint components</a> as a way to abstract the complexity of SPARQL
				and to declare high-level reusable components similar to the <a href="https://www.w3.org/TR/shacl12-core/#core-components">Core constraint components</a>.
				Such constraint components can be declared using the SHACL RDF vocabulary and thus shared and reused.
			</p>

			<section class="informative" id="an-example-sparql-based-constraint-component"><div class="header-wrapper"><h3 id="x3-1-an-example-sparql-based-constraint-component"><bdi class="secno">3.1 </bdi>An Example SPARQL-based Constraint Component</h3><a class="self-link" href="#an-example-sparql-based-constraint-component" aria-label="Permalink for Section 3.1"></a></div><p><em>This section is non-normative.</em></p>
				
				<p>
					The following example demonstrates how SPARQL can be used to specify new constraint components using the SHACL-SPARQL language.
					The example implements <a href="https://www.w3.org/TR/shacl12-core/#PatternConstraintComponent"><code>sh:pattern</code> and <code>sh:flags</code></a> using a
					<a href="#SPARQLAskValidator">SPARQL ASK</a> query to validate that each <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value-node">value node</a> matches a given regular expression.
					Note that this is only an example implementation and should not be considered normative.
				</p>
				<aside class="example" id="example-constraint-component-based-on-sparql"><div class="marker">
    <a class="self-link" href="#example-constraint-component-based-on-sparql">Example<bdi> 4</bdi></a><span class="example-title">: Constraint component based on SPARQL</span>
  </div>
					<div class="shapes-graph">
						
						
					<aside class="ds-selector-tabs"><div class="selectors">
						<button class="selected" data-selects="turtle">Turtle</button>
						<button data-selects="jsonld">JSON-LD</button>
					</div><div class="turtle selected tab">
sh:PatternConstraintComponent
	a sh:ConstraintComponent ;
	sh:parameter [
		sh:path sh:pattern ;
	] ;
	sh:parameter [
		sh:path sh:flags ;
		sh:optional true ;
	] ;
	sh:validator ex:hasPattern .

ex:hasPattern
	a sh:SPARQLAskValidator ;
	sh:message "Value does not match pattern {$pattern}" ;
	sh:ask """
		ASK { 
			FILTER (!isBlank($value) &amp;&amp; 
				IF(bound($flags), regex(str($value), $pattern, $flags), regex(str($value), $pattern)))
		}""" .
						</div><div class="jsonld tab">
							<pre class="jsonld" aria-busy="false"><code class="hljs">{
	"@graph": [
		{
			"@id": "ex:hasPattern",
			"@type": "sh:SPARQLAskValidator",
			"sh:ask": "\n\t\tASK { \n\t\t\tFILTER (!isBlank($value) &amp;&amp; \n\t\t\t\tIF(bound($flags), regex(str($value), $pattern, $flags), regex(str($value), $pattern)))\n\t\t}",
			"sh:message": "Value does not match pattern {$pattern}"
		},
		{
			"@id": "sh:PatternConstraintComponent",
			"@type": "sh:ConstraintComponent",
			"sh:parameter": [
				{
					"sh:path": {
						"@id": "sh:pattern"
					}
				},
				{
					"sh:optional": {
						"@type": "xsd:boolean",
						"@value": "true"
					},
					"sh:path": {
						"@id": "sh:flags"
					}
				}
			],
			"sh:validator": {
				"@id": "ex:hasPattern"
			}
		}
	]
}</code></pre>
						</div></aside></div>
				</aside>
				<p>
					Constraint components provide instructions to validation engines on how to identify and validate <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-constraint">constraints</a> within a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shape">shape</a>.
					In general, if a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shape">shape</a> <code>S</code> has a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> for a property <code>p</code>, and there is a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-constraint-component">constraint component</a>
					<code>C</code> that specifies <code>p</code> as a parameter, and <code>S</code> has values for all <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-mandatory-parameter">mandatory parameters</a> of <code>C</code>,
					then the set of these parameter values (including the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-optional-parameter">optional parameters</a>) declare a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-constraint">constraint</a> and the validation engine uses a suitable <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-validators">validator</a> from <code>C</code>
					to perform the validation of this constraint.
					In the example above, <code>sh:PatternConstraintComponent</code> declares the mandatory parameter <code>sh:pattern</code>,
					the optional parameter <code>sh:flags</code>,
					and a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-validators">validator</a> that can be used to perform validation against either <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-node-shape">node shapes</a> or <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-property-shape">property shapes</a>.
				</p>
			</section>
			
			<section id="constraint-components-syntax"><div class="header-wrapper"><h3 id="x3-2-syntax-of-sparql-based-constraint-components"><bdi class="secno">3.2 </bdi>Syntax of SPARQL-based Constraint Components</h3><a class="self-link" href="#constraint-components-syntax" aria-label="Permalink for Section 3.2"></a></div>
				
				<p class="syntax">
					<span data-syntax-rule="ConstraintComponent" id="syntax-rule-ConstraintComponent">A <dfn data-lt="SPARQL-based constraint components|SPARQL-based constraint component" data-plurals="sparql-based constraint components" id="dfn-sparql-based-constraint-components" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">SPARQL-based constraint component</dfn> is an <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRI</a> that has <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shacl-type">SHACL type</a>
					<code>sh:ConstraintComponent</code> in the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shapes-graph">shapes graph</a>.</span>
				</p>
				<p>
					The mechanism to declare new <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-constraint-component">constraint components</a> in this document is limited to those based on SPARQL.
					However, then general syntax of declaring parameters and validators has been designed to also work for other extension languages such as JavaScript.
				</p>
			
				<section id="constraint-components-parameters"><div class="header-wrapper"><h4 id="x3-2-1-parameter-declarations-sh-parameter"><bdi class="secno">3.2.1 </bdi>Parameter Declarations (sh:parameter)</h4><a class="self-link" href="#constraint-components-parameters" aria-label="Permalink for Section 3.2.1"></a></div>
					
					<p class="syntax">
						The <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-parameter">parameters</a> of a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-constraint-component">constraint component</a> are declared via the property <code>sh:parameter</code>.
						The values of <code>sh:parameter</code> are called <dfn data-lt="parameter declaration|parameter declarations" id="dfn-parameter-declaration" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">parameter declarations</dfn>.
						The class <code>sh:Parameter</code> may be used as <a data-link-type="dfn" href="https://www.w3.org/TR/vc-data-model/#dfn-type">type</a> of <a href="#dfn-parameter-declaration" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-parameter-declaration-1">parameter declarations</a> but no such triple is required.
						<span data-syntax-rule="Parameter-predicate-count" id="syntax-rule-Parameter-predicate-count">Each <a href="#dfn-parameter-declaration" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-parameter-declaration-2">parameter declaration</a> has exactly one value for the property <code>sh:path</code></span>.
						<span data-syntax-rule="Parameter" id="syntax-rule-Parameter">At <a href="#dfn-parameter-declaration" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-parameter-declaration-3">parameter declarations</a>, the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> of <code>sh:path</code> is an <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRI</a>.</span>
					</p>
					<p>
						The <dfn data-lt="local names|local name" id="dfn-local-names" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">local name</dfn> of an <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRI</a> is defined as the longest <a href="https://www.w3.org/TR/xml-names/#NT-NCName">NCNAME</a>
						at the end of the <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRI</a>, not immediately preceded by the first colon in the <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRI</a>.
						The <dfn data-lt="parameter names|parameter name" id="dfn-parameter-names" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">parameter name</dfn> of a <a href="#dfn-parameter-declaration" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-parameter-declaration-4">parameter declaration</a> is defined as the <a href="#dfn-local-names" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-local-names-1">local name</a> of the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> of <code>sh:path</code>.
						To ensure that a correct mapping from parameters into SPARQL variables is possible, the following syntax rules apply:
					</p>
					<p class="syntax">
						<span data-syntax-rule="parameter-name-VARNAME" id="syntax-rule-parameter-name-VARNAME">Every <a href="#dfn-parameter-names" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-parameter-names-2">parameter name</a> is a valid <a href="https://www.w3.org/TR/sparql12-query/#rVARNAME">SPARQL VARNAME</a>.</span>
						<span data-syntax-rule="parameter-name-not-in" id="syntax-rule-parameter-name-not-in"><a href="#dfn-parameter-names" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-parameter-names-3">Parameter names</a> must not be one of the following: <code>this</code>, <code>shapesGraph</code>, <code>currentShape</code>, <code>path</code>, <code>PATH</code>, <code>value</code>.</span>
						<span data-syntax-rule="parameter-name-unique" id="syntax-rule-parameter-name-unique">A constraint component where two or more <a href="#dfn-parameter-declaration" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-parameter-declaration-5">parameter declarations</a> use the same <a href="#dfn-parameter-names" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-parameter-names-4">parameter names</a> is <a href="#dfn-ill-formed" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-ill-formed-3">ill-formed</a>.</span>
					</p>
					<p class="syntax">
						<span data-syntax-rule="optional-datatype" id="syntax-rule-optional-datatype">The values of <code>sh:optional</code> must be literals with datatype <code>xsd:boolean</code>.</span>
						<span data-syntax-rule="optional-maxCount" id="syntax-rule-optional-maxCount">A <a href="#dfn-parameter-declaration" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-parameter-declaration-6">parameter declaration</a> can have at most one value for the property <code>sh:optional</code>.</span>
						If set to <code>true</code> then the parameter declaration declares an <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-optional-parameter">optional parameter</a>.
						<span data-syntax-rule="ConstraintComponent-parameter" id="syntax-rule-ConstraintComponent-parameter">Every <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-constraint-component">constraint component</a> has at least one non-optional parameter.</span>
					</p>
					<p class="syntax">
						The class <code>sh:Parameter</code> is defined as a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shacl-subclass">SHACL subclass</a> of <code>sh:PropertyShape</code>,
						and all properties that are applicable to property shapes may also be used for parameters.
						This includes descriptive properties such as <code>sh:name</code> and <code>sh:description</code>
						but also constraint parameters such as <code>sh:class</code>.
						<span data-syntax-rule="Parameter-conformance" id="syntax-rule-Parameter-conformance">Shapes that do not <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-conform">conform</a> with the constraints declared for the parameters are <a href="#dfn-ill-formed" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-ill-formed-4">ill-formed</a>.</span>
						Some implementations <em class="rfc2119">MAY</em> use these constraint parameters to prevent the execution of constraint components with invalid parameter values.
					</p>
				</section>
				<section id="labelTemplate"><div class="header-wrapper"><h4 id="x3-2-2-label-templates-sh-labeltemplate"><bdi class="secno">3.2.2 </bdi>Label Templates (sh:labelTemplate)</h4><a class="self-link" href="#labelTemplate" aria-label="Permalink for Section 3.2.2"></a></div>
					
					<p class="syntax">
						The property <code>sh:labelTemplate</code> can be used at any <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-constraint-component">constraint component</a> to suggest how <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-constraint">constraints</a> could be rendered to humans.
						<span data-syntax-rule="labelTemplate-datatype" id="syntax-rule-labelTemplate-datatype">The values of <code>sh:labelTemplate</code> are strings (possibly with language tag)</span> and
						are called <dfn data-lt="label template|label templates" id="dfn-label-template" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">label templates</dfn>.
					</p>
					<p><em>The remainder of this section is informative.</em></p>
					<p>
					 	<a href="#dfn-label-template" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-label-template-1">Label templates</a> can include the names of the parameters that are declared for the constraint component
					 	using the syntaxes <code>{?varName}</code> or <code>{$varName}</code>,
						where <code>varName</code> is the name of the <a href="#dfn-parameter-names" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-parameter-names-5">parameter name</a>.
						At display time, these <code>{?varName}</code> and <code>{$varName}</code> blocks <em class="rfc2119">SHOULD</em> be replaced with the actual parameter values.
						There may be multiple label templates for the same subject, but they should not have the same language tags.
					</p>
				</section>
				
				<section id="constraint-components-validators"><div class="header-wrapper"><h4 id="x3-2-3-validators"><bdi class="secno">3.2.3 </bdi>Validators</h4><a class="self-link" href="#constraint-components-validators" aria-label="Permalink for Section 3.2.3"></a></div>
					
					<p>
						For every supported shape type (i.e., <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-property-shape">property shape</a> or <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-node-shape">node shape</a>)
						the constraint component declares a suitable <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-validators">validator</a>.
						For a given constraint, a validator is selected from the constraint component using the following rules, in order:
					</p>
					<ol>
						<li>For <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-node-shape">node shapes</a>, use one of the values of <code>sh:nodeValidator</code>, if present.</li>
						<li>For <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-property-shape">property shapes</a>, use one of the values of <code>sh:propertyValidator</code>, if present.</li>
						<li>Otherwise, use one of the values of <code>sh:validator</code>.
					</li></ol>
					<p>
						If no suitable validator can be found, a SHACL-SPARQL processor ignores the constraint.
					</p>
					<p>
						SHACL-SPARQL includes two types of validators, based on <a href="#SPARQLSelectValidator">SPARQL SELECT</a> (for <code>sh:nodeValidator</code> and <code>sh:propertyValidator</code>)
						or <a href="#SPARQLAskValidator">SPARQL ASK</a> queries (for <code>sh:validator</code>).
					</p>
					<section id="SPARQLSelectValidator"><div class="header-wrapper"><h5 id="x3-2-3-1-select-based-validators"><bdi class="secno">3.2.3.1 </bdi>SELECT-based Validators</h5><a class="self-link" href="#SPARQLSelectValidator" aria-label="Permalink for Section 3.2.3.1"></a></div>
						
						<p class="syntax">
							<a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-validators">Validators</a> with <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shacl-type">SHACL type</a> <code>sh:SPARQLSelectValidator</code> are called <dfn id="dfn-select-based-validators" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">SELECT-based validators</dfn>.
							<span data-syntax-rule="nodeValidator-class" id="syntax-rule-nodeValidator-class">The values of <code>sh:nodeValidator</code> must be <a href="#dfn-select-based-validators" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-select-based-validators-2">SELECT-based validators</a>.</span>
							<span data-syntax-rule="propertyValidator-class" id="syntax-rule-propertyValidator-class">The values of <code>sh:propertyValidator</code> must be <a href="#dfn-select-based-validators" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-select-based-validators-3">SELECT-based validators</a>.</span>
							<span data-syntax-rule="SPARQLSelectValidator-select-count" id="syntax-rule-SPARQLSelectValidator-select-count"><a href="#dfn-select-based-validators" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-select-based-validators-4">SELECT-based validators</a> have exactly one <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> for the property <code>sh:select</code>.</span>
							The value of <code>sh:select</code> is a valid SPARQL SELECT query using the aforementioned <a href="#sparql-prefixes">prefix handling rules</a>.
							The SPARQL query derived from the value of <code>sh:select</code> <a href="https://www.w3.org/TR/sparql12-query/#selectproject">projects</a> the variable <code>this</code> in its SELECT clause.
						</p>
						<p><em>The remainder of this section is informative.</em></p>
						<p>
							The following example illustrates the declaration of a constraint component based on a SPARQL SELECT query.
							It is a generalized variation of the example from <a href="#sparql-constraints-example" class="sec-ref"><bdi class="secno">2.1 </bdi>An Example SPARQL-based Constraint</a>.
							That SPARQL query included two constants: the specific property <code>ex:germanLabel</code> and the language tag <code>de</code>.
							Constraint components make it possible to generalize such scenarios, so that constants get <a href="#dfn-pre-binding" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-pre-binding-4">pre-bound</a> with <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-parameter">parameters</a>.
							This allows the query logic to be reused in multiple places, without having to write any new SPARQL.
						</p>
						<aside class="example" id="example-constraint-component-based-on-sparql-0"><div class="marker">
    <a class="self-link" href="#example-constraint-component-based-on-sparql-0">Example<bdi> 5</bdi></a><span class="example-title">: Constraint component based on SPARQL</span>
  </div>
							<div class="shapes-graph">
								
								
							<aside class="ds-selector-tabs"><div class="selectors">
						<button class="selected" data-selects="turtle">Turtle</button>
						<button data-selects="jsonld">JSON-LD</button>
					</div><div class="turtle selected tab">
ex:LanguageConstraintComponentUsingSELECT
	a sh:ConstraintComponent ;
	rdfs:label "Language constraint component" ;
	sh:parameter [
		sh:path ex:lang ;
		sh:datatype xsd:string ;
		sh:minLength 2 ;
		sh:name "language" ;
		sh:description "The language tag, e.g. \"de\"." ;
	] ;
	sh:labelTemplate "Values are literals with language \"{$lang}\"" ;
	sh:propertyValidator [
		a sh:SPARQLSelectValidator ;
		sh:message "Values are literals with language \"{?lang}\"" ;
		sh:select """
			SELECT DISTINCT $this ?value
			WHERE {
				$this $PATH ?value .
				FILTER (!isLiteral(?value) || !langMatches(lang(?value), $lang))
			}
			"""
	] .
								</div><div class="jsonld tab">
									<pre class="jsonld" aria-busy="false"><code class="hljs">{
	"@id": "ex:LanguageConstraintComponentUsingSELECT",
	"@type": "sh:ConstraintComponent",
	"rdfs:label": "Language constraint component",
	"sh:labelTemplate": "Values are literals with language \"{$lang}\"",
	"sh:parameter": {
		"sh:datatype": {
			"@id": "xsd:string"
		},
		"sh:description": "The language tag, e.g. \"de\".",
		"sh:minLength": {
			"@type": "xsd:integer",
			"@value": "2"
		},
		"sh:name": "language",
		"sh:path": {
			"@id": "ex:lang"
		}
	},
	"sh:propertyValidator": {
		"@type": "sh:SPARQLSelectValidator",
		"sh:message": "Values are literals with language \"{?lang}\"",
		"sh:select": "\n\t\t\tSELECT DISTINCT $this ?value\n\t\t\tWHERE {\n\t\t\t\t$this $PATH ?value .\n\t\t\t\tFILTER (!isLiteral(?value) || !langMatches(lang(?value), $lang))\n\t\t\t}\n\t\t\t"
	}
}</code></pre>
								</div></aside></div>
						</aside>
						<p>
							Once a constraint component has been declared (in a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shapes-graph">shapes graph</a>), its parameters can be used as illustrated in the following example.
						</p>
						<aside class="example" id="example-shape-declaration-using-ex-languageconstraintcomponent"><div class="marker">
    <a class="self-link" href="#example-shape-declaration-using-ex-languageconstraintcomponent">Example<bdi> 6</bdi></a><span class="example-title">: Shape declaration using ex:LanguageConstraintComponent</span>
  </div>
							<div class="shapes-graph">
								
								
							<aside class="ds-selector-tabs"><div class="selectors">
						<button class="selected" data-selects="turtle">Turtle</button>
						<button data-selects="jsonld">JSON-LD</button>
					</div><div class="turtle selected tab">
ex:LanguageExampleShape
	a sh:NodeShape ;
	<span class="target-can-be-skipped">sh:targetClass ex:Country ;</span>
	sh:property [
		sh:path ex:germanLabel ;
		ex:lang "de" ;
	] ;
	sh:property [
		sh:path ex:englishLabel ;
		ex:lang "en" ;
	] .
								</div><div class="jsonld tab">
									<pre class="jsonld" aria-busy="false"><code class="hljs">{
	"@id": "ex:LanguageExampleShape",
	"@type": "sh:NodeShape",
	"sh:property": [
		{
			"ex:lang": "de",
			"sh:path": {
				"@id": "ex:germanLabel"
			}
		},
		{
			"ex:lang": "en",
			"sh:path": {
				"@id": "ex:englishLabel"
			}
		}
	],
	"sh:targetClass": {
		"@id": "ex:Country"
	}
}</code></pre>
								</div></aside></div>
						</aside>
						<p>
							The example shape above specifies the condition that all values of <code>ex:germanLabel</code> carry the language tag <code>de</code>
							while all values of <code>ex:englishLabel</code> have <code>en</code> as their language.
							These details are specified via two property shapes that have values for the <code>ex:lang</code> parameter required by the constraint component.
						</p>
					</section>
					<section id="SPARQLAskValidator"><div class="header-wrapper"><h5 id="x3-2-3-2-ask-based-validators"><bdi class="secno">3.2.3.2 </bdi>ASK-based Validators</h5><a class="self-link" href="#SPARQLAskValidator" aria-label="Permalink for Section 3.2.3.2"></a></div>
						
						<p>
							Many constraint components are of the form in which all <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value-node">value nodes</a> are tested individually against some boolean condition.
							Writing SELECT queries for these becomes burdensome, especially if a constraint component can be
							used for both <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-property-shape">property shapes</a> and <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-node-shape">node shapes</a>.
							SHACL-SPARQL provides an alternative, more compact syntax for validators based on ASK queries.
						</p>
						<p class="syntax">
							<a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-validators">Validators</a> with <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shacl-type">SHACL type</a> <code>sh:SPARQLAskValidator</code> are called <dfn id="dfn-ask-based-validators" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">ASK-based validators</dfn>.
							<span data-syntax-rule="validator-class" id="syntax-rule-validator-class">The values of <code>sh:validator</code> must be <a href="#dfn-ask-based-validators" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-ask-based-validators-1">ASK-based validators</a>.</span>
							<span data-syntax-rule="ask-count" id="syntax-rule-ask-count"><a href="#dfn-ask-based-validators" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-ask-based-validators-2">ASK-based validators</a> have exactly one value for the property <code>sh:ask</code></span>.
							<span data-syntax-rule="ask-datatype" id="syntax-rule-ask-datatype">The value of <code>sh:ask</code> must be a literal with datatype <code>xsd:string</code>.</span>
							<span data-syntax-rule="ask-sparql" id="syntax-rule-ask-sparql">The value of <code>sh:ask</code> must be a valid SPARQL ASK query using the aforementioned <a href="#sparql-prefixes">prefix handling rules</a>.</span>
						</p>
						<p><em>The remainder of this section is informative.</em></p>
						<p>
							The ASK queries return <code>true</code> if and only if a given <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value-node">value node</a>
							(represented by the pre-bound variable <code>value</code>) conforms to the constraint.
						</p>
						<p>
							The following example declares a constraint component using an ASK query.
						</p>
						<aside class="example" id="example-constraint-component-based-on-sparql-1"><div class="marker">
    <a class="self-link" href="#example-constraint-component-based-on-sparql-1">Example<bdi> 7</bdi></a><span class="example-title">: Constraint component based on SPARQL</span>
  </div>
							<div class="shapes-graph">
								
								
							<aside class="ds-selector-tabs"><div class="selectors">
						<button class="selected" data-selects="turtle">Turtle</button>
						<button data-selects="jsonld">JSON-LD</button>
					</div><div class="turtle selected tab">
ex:LanguageConstraintComponentUsingASK
	a sh:ConstraintComponent ;
	rdfs:label "Language constraint component" ;
	sh:parameter [
		sh:path ex:lang ;
		sh:datatype xsd:string ;
		sh:minLength 2 ;
		sh:name "language" ;
		sh:description "The language tag, e.g. \"de\"." ;
	] ;
	sh:labelTemplate "Values are literals with language \"{$lang}\"" ;
	sh:validator ex:hasLang .
	
ex:hasLang
	a sh:SPARQLAskValidator ;
	sh:message "Values are literals with language \"{$lang}\"" ;
	sh:ask """
		ASK {
			FILTER (isLiteral($value) &amp;&amp; langMatches(lang($value), $lang))
		}
		""" .
								</div><div class="jsonld tab">
									<pre class="jsonld" aria-busy="false"><code class="hljs">{
	"@graph": [
		{
			"@id": "ex:hasLang",
			"@type": "sh:SPARQLAskValidator",
			"sh:ask": "\n\t\tASK {\n\t\t\tFILTER (isLiteral($value) &amp;&amp; langMatches(lang($value), $lang))\n\t\t}\n\t\t",
			"sh:message": "Values are literals with language \"{$lang}\""
		},
		{
			"@id": "ex:LanguageConstraintComponentUsingASK",
			"@type": "sh:ConstraintComponent",
			"rdfs:label": "Language constraint component",
			"sh:labelTemplate": "Values are literals with language \"{$lang}\"",
			"sh:parameter": {
				"sh:datatype": {
					"@id": "xsd:string"
				},
				"sh:description": "The language tag, e.g. \"de\".",
				"sh:minLength": {
					"@type": "xsd:integer",
					"@value": "2"
				},
				"sh:name": "language",
				"sh:path": {
					"@id": "ex:lang"
				}
			},
			"sh:validator": {
				"@id": "ex:hasLang"
			}
		}
	]
}</code></pre>
								</div></aside></div>
						</aside>
						<p>
							Note that the validation condition implemented by an ASK query is "in the inverse direction" from its SELECT counterpart:
							ASK queries return <code>true</code> for value nodes that conform to the constraint, while SELECT queries return those value nodes that do not conform.
						</p>
					</section>
				</section>
			</section>
			<section id="constraint-components-validation"><div class="header-wrapper"><h3 id="x3-3-validation-with-sparql-based-constraint-components"><bdi class="secno">3.3 </bdi>Validation with SPARQL-based Constraint Components</h3><a class="self-link" href="#constraint-components-validation" aria-label="Permalink for Section 3.3"></a></div>
				
				<p>
					This section defines the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-validators">validator</a> of <a href="#dfn-sparql-based-constraint-components" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-components-5">SPARQL-based constraint components</a>.
					Note that this validator only explains one possible implementation strategy, and
					SHACL processors may choose alternative approaches as long as the outcome is equivalent.
				</p>
				<p>
					As the first step, a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-validators">validator</a> <em class="rfc2119">MUST</em> be selected based on the rules outlined
					in <a href="#constraint-components-validators" class="sec-ref"><bdi class="secno">3.2.3 </bdi>Validators</a>.
					Then the following rules apply, producing a set of <a href="#dfn-solutions" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-solutions-5">solutions</a> of SPARQL queries:
				</p>
				<ul>
					<li>
						For <a href="#dfn-ask-based-validators" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-ask-based-validators-3">ASK-based validators</a>: 
						For each <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value-node">value node</a> <code>v</code> where the SPARQL ASK query returns <code>false</code>
						with <code>v</code> <a href="#dfn-pre-binding" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-pre-binding-5">pre-bound</a> to the variable <code>value</code>,
						create one <a href="#dfn-solutions" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-solutions-6">solution</a> consisting of the bindings
						(<code>$this</code>, <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-focus-node">focus node</a>) and (<code>$value</code>, <code>v</code>).
						Let <code>QS</code> be a list of these <a href="#dfn-solutions" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-solutions-7">solutions</a>.
					</li>
					<li>
						For <a href="#dfn-select-based-validators" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-select-based-validators-5">SELECT-based validators</a>:
						If the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shape">shape</a> is a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-property-shape">property shape</a>, then prior to execution
						<a href="#dfn-substituted" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-substituted-2">substitute</a> the variable <code>PATH</code> where it appears in the <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-predicate">predicate</a>
						position of a <a href="https://www.w3.org/TR/sparql12-query/#QSynTriples">triple pattern</a>
						with a valid SPARQL surface syntax string of the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shacl-property-path">SHACL property path</a>
						specified via <code>sh:path</code> at the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-property-shape">property shape</a>.
						Let <code>QS</code> be the <a href="#dfn-solutions" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-solutions-8">solutions</a> produced by executing the SPARQL query.
					</li>
				</ul>
				<p>
					The SPARQL query executions above <em class="rfc2119">MUST</em> <a href="#dfn-pre-binding" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-pre-binding-6">pre-bind</a> the variables
					<code>this</code> and, if supported, <code>shapesGraph</code> and <code>currentShape</code>
					as described in <a href="#sparql-constraints-prebound" class="sec-ref"><bdi class="secno">2.3.1 </bdi>Pre-bound Variables in SPARQL Constraints ($this, $shapesGraph, $currentShape)</a>.
					In addition, each <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> of a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-parameter">parameter</a> of the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-constraint-component">constraint component</a> in the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-constraint">constraint</a>
					<em class="rfc2119">MUST</em> be <a href="#dfn-pre-binding" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-pre-binding-7">pre-bound</a> as a variable that has the <a href="#dfn-parameter-names" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-parameter-names-6">parameter name</a> as its name.
				</p>
				<p>
					The production rules for the validation results are identical to those for <a href="#sparql-constraints-validation-rule">SPARQL-based constraints</a>,
					using the <a href="#dfn-solutions" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-solutions-9">solutions</a> <code>QS</code> as produced above.
				</p>
			</section>
		</section>
				
		<section id="sparql-constraints-annotations"><div class="header-wrapper"><h2 id="x4-annotation-properties"><bdi class="secno">4. </bdi>Annotation Properties</h2><a class="self-link" href="#sparql-constraints-annotations" aria-label="Permalink for Section 4."></a></div>
			
			<p>
				This section extends the general <a href="#sparql-constraints-variables">mechanism</a>
				to produce validation results using <a href="sparql-constraints">SPARQL-based constraints</a> or
				<a href="sparql-constraint-components">constraint components</a>.
			</p>
			<p>
				Implementations that support this feature make it possible to inject <dfn id="dfn-annotation-properties" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">annotation properties</dfn>
				into the validation result nodes created for each <a href="#dfn-solutions" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-solutions-10">solution</a> produced by the <code>SELECT</code> queries of a
				SPARQL-based <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-constraint">constraint</a> or <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-constraint-component">constraint component</a>.
				Any such annotation property needs to be declared via a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> of <code>sh:resultAnnotation</code> at
				the <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-subject">subject</a> of the <code>sh:select</code> or <code>sh:ask</code> <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-rdf-triple">triple</a>.
			</p>
			<p class="syntax">
				<span data-syntax-rule="resultAnnotation-nodeKind" id="syntax-rule-resultAnnotation-nodeKind">The <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">values</a> of <code>sh:resultAnnotation</code> are
				called <dfn data-lt="result annotation|result annotations" id="dfn-result-annotation" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">result annotations</dfn> and are either <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRIs</a> or <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-blank-node">blank nodes</a></span>.
			</p>
			<p>
				<a href="#dfn-result-annotation" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-result-annotation-1">Result annotations</a> have the following properties:
			</p>
			<table class="term-table">
				<tbody><tr>
					<th>Property</th>
					<th>Summary and Syntax Rules</th>
				</tr>
				<tr>
					<td><code>sh:annotationProperty</code></td>
					<td>
						The property that shall be set.
						<span data-syntax-rule="annotationProperty" id="syntax-rule-annotationProperty">Each <a href="#dfn-result-annotation" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-result-annotation-2">result annotation</a> has exactly one <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a>
						for the property <code>sh:annotationProperty</code> and this value is an <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRI</a>.</span>
					</td>
				</tr>
				<tr>
					<td><code>sh:annotationVarName</code></td>
					<td>
						The name of the SPARQL variable to take the annotation values from.
						<span data-syntax-rule="annotationVarName" id="syntax-rule-annotationVarName">Each <a href="#dfn-result-annotation" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-result-annotation-3">result annotation</a> has at most 1 <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a>
						for the property <code>sh:annotationVarName</code> and this <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> is <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-literal">literal</a> with
						<a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-datatype">datatype</a> <code>xsd:string</code>.</span>
					</td>
				</tr>
				<tr>
					<td><code>sh:annotationValue</code></td>
					<td>
						Constant <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-rdf-term">RDF terms</a> that shall be used as default values.
					</td>
				</tr>
			</tbody></table>
			<p>
				For each <a href="#dfn-solutions" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-solutions-11">solution</a> of a <code>SELECT</code> result set, a SHACL processor that supports annotations
				walks through the declared result annotations.
				The mapping from result annotations to SPARQL variables uses the following rules:
			</p>
			<ol>
				<li>Use the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> of the property <code>sh:annotationVarName</code></li>
				<li>If no such <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> exists, use the <a href="#dfn-local-names" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-local-names-2">local name</a> of the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> of <code>sh:annotationProperty</code> 
				as the variable name.</li>
			</ol>
			<p>
				If a variable name could be determined, then the SHACL processor copies the <a href="#dfn-bindings" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-bindings-5">binding</a> for the given variable
				as a value for the property specified using <code>sh:annotationProperty</code> 
				into the validation result that is being produced for the current <a href="#dfn-solutions" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-solutions-12">solution</a>.
				If the variable has no <a href="#dfn-bindings" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-bindings-6">binding</a> in the result set <a href="#dfn-solutions" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-solutions-13">solution</a>,
				then the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">values</a> of <code>sh:annotationValue</code> are used, if present.
			</p>
			<p>
				Here is an example illustrating the use of result annotations.
			</p>
			<pre class="example-shapes" aria-busy="false"><code class="hljs">ex:AnnotationExample
	a sh:NodeShape ;
	sh:targetNode ex:ExampleResource ;
	sh:sparql [   # _:b1
		sh:resultAnnotation [
			sh:annotationProperty ex:time ;
			sh:annotationVarName "time" ;
		] ;
		sh:select """
			SELECT $this ?message ?time
			WHERE {
				BIND (CONCAT("The ", "message.") AS ?message) .
				BIND (NOW() AS ?time) .
			}
			""" ;
	] .</code></pre>
			<p>
				Validation produces the following validation report:
			</p>
			<pre class="example-results" aria-busy="false"><code class="hljs">[	a sh:ValidationReport ;
	sh:conforms false ;
	sh:result [
		a sh:ValidationResult ;
		sh:focusNode ex:ExampleResource ;
		sh:resultMessage "The message." ;
		sh:resultSeverity sh:Violation ;
		sh:sourceConstraint _:b1 ;
		sh:sourceConstraintComponent sh:SPARQLConstraintComponent ;
		sh:sourceShape ex:AnnotationExample ;
		ex:time "2015-03-27T10:58:00"^^xsd:dateTime ;  # Example
	]
] .</code></pre>
		</section>

		<section id="sparql-node-expressions"><div class="header-wrapper"><h2 id="x5-sparql-based-node-expressions"><bdi class="secno">5. </bdi>SPARQL-based Node Expressions</h2><a class="self-link" href="#sparql-node-expressions" aria-label="Permalink for Section 5."></a></div>
			
			<p>
				This section introduces <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-node-expression-function">node expression functions</a> based on SPARQL.
			</p>

			<section id="SelectExpression"><div class="header-wrapper"><h3 id="x5-1-select-expressions"><bdi class="secno">5.1 </bdi>Select Expressions</h3><a class="self-link" href="#SelectExpression" aria-label="Permalink for Section 5.1"></a></div>
				
				<p>
					A <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-node-expression">node expression</a> that has a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> for <code>sh:select</code> is called a <dfn id="dfn-select-expression" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">select expression</dfn> with the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-function-name">function name</a>
					<code>sh:SelectExpression</code>.
				</p>
				<p class="syntax">
					<span data-syntax-rule="SelectExpression-syntax" id="syntax-rule-SelectExpression-syntax">A node in an RDF graph is a <a href="#dfn-well-formed" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-well-formed-1">well-formed</a> <a href="#dfn-select-expression" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-select-expression-1">select expression</a> if it is a <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-blank-node">blank node</a>
					that has exactly one <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> for the <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-predicate">predicate</a> <code>sh:select</code>
					and this <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> is a <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-literal">literal</a> with <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-datatype">datatype</a> <code>xsd:string</code>.</span>
					<span data-syntax-rule="SelectExpression-syntax-prefixes" id="syntax-rule-SelectExpression-syntax-prefixes">A <a href="#dfn-well-formed" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-well-formed-2">well-formed</a> <a href="#dfn-select-expression" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-select-expression-2">select expression</a> can have at most one <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> for the property
					<code>sh:prefixes</code> and this value can only be an <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRI</a> or a <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-blank-node">blank node</a>.</span><br><br>
					<span data-syntax-rule="SelectExpression-query-valid" id="syntax-rule-SelectExpression-query-valid">Using the <a href="#sparql-prefixes">prefix handling rules</a>, the value of <code>sh:select</code> is a valid SPARQL 1.2 SELECT query.</span>
					<span data-syntax-rule="SelectExpression-query-output-nodes" id="syntax-rule-SelectExpression-query-output-nodes">The SPARQL query derived from the value of <code>sh:select</code> <a href="https://www.w3.org/TR/sparql12-query/#selectproject">projects</a> exactly one variable in the SELECT clause.</span>
				</p>
				<div class="def" id="SelectExpression-evaluation">
					<div class="def-header">EVALUATION OF SELECT EXPRESSIONS</div>
					<p>
						The <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-output-nodes">output nodes</a> of a <a href="#dfn-select-expression" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-select-expression-3">select expression</a> are the list <code>resultNodes</code> consisting of exactly the bindings of the (only)
						variable that is projected from the <code>SELECT</code> clause when the query is evaluated against the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-focus-graph">focus graph</a>.
						The value of <code>focusNode</code> is <a href="#dfn-pre-binding" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-pre-binding-8">pre-bound</a> as the value of the SPARQL variable <code>this</code>.
						The value of each scope variable is <a href="#dfn-pre-binding" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-pre-binding-9">pre-bound</a> as a SPARQL variable with the same name and value.
						A <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-failure">failure</a> is produced when one of the scope variables is called <code>this</code>.
						<br>
						<br>
						<code>evalExpr(expr, focusGraph, focusNode, scope) -&gt; resultNodes</code>
					</p>
				</div>
				<p><em>The remainder of this section is informative.</em></p>
				<aside class="example" id="example-a-dynamically-computed-property-using-a-node-expression-based-on-a-sparql-query"><div class="marker">
    <a class="self-link" href="#example-a-dynamically-computed-property-using-a-node-expression-based-on-a-sparql-query">Example<bdi> 8</bdi></a><span class="example-title">: A dynamically computed property using a node expression based on a SPARQL query</span>
  </div>
					<p>
						Here is an example use of a <a href="#dfn-select-expression" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-select-expression-4">select expression</a>, computing the values of a property shape for the property 
						"full name" as the concatenation of the <code>ex:firstName</code>, a space, and the <code>ex:lastName</code>.
					</p>
					<div class="shapes-graph">
						
						
					<aside class="ds-selector-tabs"><div class="selectors">
						<button class="selected" data-selects="turtle">Turtle</button>
						<button data-selects="jsonld">JSON-LD</button>
					</div><div class="turtle selected tab">
ex:Person-fullName
	a sh:PropertyShape ;
	sh:name "full name" ;
	sh:path ex:fullName ;
	sh:values <b>[
		sh:prefixes &lt;http://example.org/ns&gt; ;
		sh:select """
			SELECT ?fullName
			WHERE {
				$this ex:firstName ?firstName .
				$this ex:lastName ?lastName .
				BIND (CONCAT(?firstName, " ", ?lastName) AS ?fullName) .
			}
		"""
	]</b> ;
	sh:datatype xsd:string .

&lt;http://example.org/ns&gt;
	a owl:Ontology ;
	sh:declare [
		sh:prefix "ex" ;
		sh:namespace "http://example.org/ns#"^^xsd:anyURI ;
	] .
						</div><div class="jsonld tab">
							<pre class="jsonld" aria-busy="false"><code class="hljs">{
	"@graph": [
		{
			"@id": "ex:Person-fullName",
			"@type": "sh:PropertyShape",
			"sh:datatype": {
				"@id": "xsd:string"
			},
			"sh:name": "full name",
			"sh:path": {
				"@id": "ex:fullName"
			},
			"sh:values": {
				"sh:prefixes": {
					"@id": "http://example.org/ns"
				},
				"sh:select": "\n\t\t\tSELECT ?fullName\n\t\t\tWHERE {\n\t\t\t\t$this ex:firstName ?firstName .\n\t\t\t\t$this ex:lastName ?lastName .\n\t\t\t\tBIND (CONCAT(?firstName, \" \", ?lastName) AS ?fullName) .\n\t\t\t}\n\t\t"
			}
		},
		{
			"@id": "http://example.org/ns",
			"@type": "owl:Ontology",
			"sh:declare": {
				"sh:namespace": {
					"@type": "xsd:anyURI",
					"@value": "http://example.org/ns#"
				},
				"sh:prefix": "ex"
			}
		}
	]
}</code></pre>
						</div></aside></div>
					<p>
						This example also illustrates the use of <code>sh:prefixes</code> to insert PREFIX declarations into the beginning of the query before parsing.
						Note that the query is executed with the current <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-focus-node">focus node</a> <a href="#dfn-pre-binding" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-pre-binding-10">pre-bound</a> to the variable <code>this</code>.
					</p>
				</aside>
				<aside class="example" id="example-dynamically-computed-target-nodes-using-a-node-expression-based-on-a-sparql-query"><div class="marker">
    <a class="self-link" href="#example-dynamically-computed-target-nodes-using-a-node-expression-based-on-a-sparql-query">Example<bdi> 9</bdi></a><span class="example-title">: Dynamically computed target nodes using a node expression based on a SPARQL query</span>
  </div>
					<p>
						Here is an example use of a <a href="#dfn-select-expression" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-select-expression-5">select expression</a>, computing the target nodes of a shape to consist of all instances of
						<code>ex:Person</code> where the <code>ex:age</code> is less than <code>18</code>.
					</p>
					<div class="shapes-graph">
						
						
					<aside class="ds-selector-tabs"><div class="selectors">
						<button class="selected" data-selects="turtle">Turtle</button>
						<button data-selects="jsonld">JSON-LD</button>
					</div><div class="turtle selected tab">
ex:ChildShape
	a sh:NodeShape ;
	rdfs:label "Child shape" ;
	rdfs:comment "This shape applies to all persons under 18 years of age." ;
	sh:targetNode <b>[
		sh:select """
			PREFIX ex: &lt;http://example.org/ns#&gt;
			SELECT ?person
			WHERE {
				?person a/rdfs:subClassOf* ex:Person .
				?person ex:age ?age .
				FILTER (?age &lt; 18) .
			}
		"""
	]</b> .
						</div><div class="jsonld tab">
							<pre class="jsonld" aria-busy="false"><code class="hljs">{
	"@id": "ex:ChildShape",
	"@type": "sh:NodeShape",
	"rdfs:comment": "This shape applies to all persons under 18 years of age.",
	"rdfs:label": "Child shape",
	"sh:targetNode": {
		"sh:select": "\n\t\t\tPREFIX ex: &lt;http://example.org/ns#&gt;\n\t\t\tSELECT ?person\n\t\t\tWHERE {\n\t\t\t\t?person a/rdfs:subClassOf* ex:Person .\n\t\t\t\t?person ex:age ?age .\n\t\t\t\tFILTER (?age &lt; 18) .\n\t\t\t}\n\t\t"
	}
}</code></pre>
						</div></aside></div>
					<p>
						From the following data graph, only <code>ex:Benjamin</code> is a target node.
					</p>
					<div class="data-graph">
						
						
					<aside class="ds-selector-tabs"><div class="selectors">
						<button class="selected" data-selects="turtle">Turtle</button>
						<button data-selects="jsonld">JSON-LD</button>
					</div><div class="turtle selected tab">
<span class="focus-node-selected">ex:Benjamin</span>
	a ex:Person ;
	ex:age 17 .

ex:Klaus
	a ex:Person ;
	ex:age 48 .

ex:Bernd
	a ex:Person .
						</div><div class="jsonld tab">
							<pre class="jsonld" aria-busy="false"><code class="hljs">{
	"@graph": [
		{
			"@id": "ex:Benjamin",
			"@type": "ex:Person",
			"ex:age": {
				"@type": "xsd:integer",
				"@value": "17"
			}
		},
		{
			"@id": "ex:Bernd",
			"@type": "ex:Person"
		},
		{
			"@id": "ex:Klaus",
			"@type": "ex:Person",
			"ex:age": {
				"@type": "xsd:integer",
				"@value": "48"
			}
		}
	]
}</code></pre>
						</div></aside></div>
				</aside>
			</section>

			<section id="SPARQLExprExpression"><div class="header-wrapper"><h3 id="x5-2-sparql-expr-expressions"><bdi class="secno">5.2 </bdi>SPARQL Expr Expressions</h3><a class="self-link" href="#SPARQLExprExpression" aria-label="Permalink for Section 5.2"></a></div>
				
				<p>
					A <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-node-expression">node expression</a> that has a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> for <code>sh:sparqlExpr</code> is called a <dfn id="dfn-sparql-expr-expression" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">SPARQL expr expression</dfn> with the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-function-name">function name</a>
					<code>sh:SPARQLExprExpression</code>.
				</p>
				<p class="syntax">
					<span data-syntax-rule="SPARQLExprExpression-syntax-eval" id="syntax-rule-SPARQLExprExpression-syntax-eval">A node in an RDF graph
					is a <a href="#dfn-well-formed" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-well-formed-3">well-formed</a> <a href="#dfn-sparql-expr-expression" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-expr-expression-1">SPARQL expr expression</a> if it is a <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-blank-node">blank node</a>
					that has exactly one <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> for the <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-predicate">predicate</a> <code>sh:sparqlExpr</code>
					and that <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> is a <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-literal">literal</a> with <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-datatype">datatype</a> <code>xsd:string</code>.</span>
					<span data-syntax-rule="SPARQLExprExpression-syntax-prefixes" id="syntax-rule-SPARQLExprExpression-syntax-prefixes">A <a href="#dfn-well-formed" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-well-formed-4">well-formed</a> <a href="#dfn-sparql-expr-expression" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-expr-expression-2">SPARQL expr expression</a> can have at most one <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> for the property
					<code>sh:prefixes</code> and this value is an <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRI</a> or a <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-blank-node">blank node</a>.</span><br><br>
					<span data-syntax-rule="SPARQLExprExpression-template" id="syntax-rule-SPARQLExprExpression-template">Let <code>$EXPR$</code> be the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> of <code>sh:eval</code> and <code>$PREFIXES$</code>
					be the SPARQL prefixes block resulting from the <a href="#sparql-prefixes">prefix handling rules</a> using the value of <code>sh:prefixes</code>;
					then <code>select</code> is defined as the string where <code>$EXPR$</code> and <code>$PREFIXES$</code> are inserted as into <br><br><code>$PREFIXES$ SELECT ($EXPR$ AS ?result) WHERE {}</code><br><br></span>
					<span data-syntax-rule="SPARQLExprExpression-query-valid" id="syntax-rule-SPARQLExprExpression-query-valid"><code>select</code> is a valid SPARQL 1.2 SELECT query.</span>
				</p>
				<div class="def" id="SPARQLExprExpression-evaluation">
					<div class="def-header">EVALUATION OF SPARQL EXPR EXPRESSIONS</div>
					<p>
						The <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-output-nodes">output nodes</a> of an <a href="#dfn-sparql-expr-expression" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-expr-expression-3">SPARQL expr expression</a> are the list <code>resultNodes</code> consisting of exactly the bindings of the (only)
						variable that is projected from the <code>SELECT</code> clause of the <code>select</code> query as defined <a href="#syntax-rule-SPARQLExprExpression-template">above</a>
						when the query is evaluated against the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-focus-graph">focus graph</a>.
						The value of <code>focusNode</code> is <a href="#dfn-pre-binding" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-pre-binding-11">pre-bound</a> as the value of the SPARQL variable <code>this</code>.
						The value of each scope variable is <a href="#dfn-pre-binding" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-pre-binding-12">pre-bound</a> as a SPARQL variable with the same name and value.
						A <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-failure">failure</a> is produced when one of the scope variables is called <code>this</code>.
						<br>
						<br>
						<code>evalExpr(expr, focusGraph, focusNode, scope) -&gt; resultNodes</code>
					</p>
				</div>
				<p><em>The remainder of this section is informative.</em></p>
				<aside class="example" id="example-a-dynamically-computed-property-using-a-sparql-expr-expression"><div class="marker">
    <a class="self-link" href="#example-a-dynamically-computed-property-using-a-sparql-expr-expression">Example<bdi> 10</bdi></a><span class="example-title">: A dynamically computed property using a SPARQL expr expression</span>
  </div>
					<p>
						Here is an example use of an <a href="#dfn-sparql-expr-expression" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-expr-expression-4">SPARQL expr expression</a>, computing the values of a property shape for the property 
						"uri length" as the length of the IRI of the focus node.
					</p>
					<div class="shapes-graph">
						
						
					<aside class="ds-selector-tabs"><div class="selectors">
						<button class="selected" data-selects="turtle">Turtle</button>
						<button data-selects="jsonld">JSON-LD</button>
					</div><div class="turtle selected tab">
ex:Resource-uriLength
	a sh:PropertyShape ;
	sh:name "uri length" ;
	sh:path ex:uriLength ;
	sh:values <b>[
		sh:sparqlExpr "STRLEN(STR($this))" ;
	]</b> ;
	sh:datatype xsd:integer .
						</div><div class="jsonld tab">
							<pre class="jsonld" aria-busy="false"><code class="hljs">{
	"@id": "ex:Resource-uriLength",
	"@type": "sh:PropertyShape",
	"sh:datatype": {
		"@id": "xsd:integer"
	},
	"sh:name": "uri length",
	"sh:path": {
		"@id": "ex:uriLength"
	},
	"sh:values": {
		"sh:sparqlExpr": "STRLEN(STR($this))"
	}
}</code></pre>
						</div></aside></div>
					<p>
						When applied to a focus node with URI <code>http://example.org/ns#Test</code> the result will be <code>26</code>.
						This produces the same results as this variation:
					</p>
					<div class="shapes-graph">
						
						
					<aside class="ds-selector-tabs"><div class="selectors">
						<button class="selected" data-selects="turtle">Turtle</button>
						<button data-selects="jsonld">JSON-LD</button>
					</div><div class="turtle selected tab">
ex:Resource-uriLength
	a sh:PropertyShape ;
	sh:name "uri length" ;
	sh:path ex:uriLength ;
	sh:values <b>[
		sh:select """
			SELECT (STRLEN(STR($this)) AS ?result)
			WHERE {
			}
		""" ;
	]</b> ;
	sh:datatype xsd:integer .
						</div><div class="jsonld tab">
							<pre class="jsonld" aria-busy="false"><code class="hljs">{
	"@id": "ex:Resource-uriLength",
	"@type": "sh:PropertyShape",
	"sh:datatype": {
		"@id": "xsd:integer"
	},
	"sh:name": "uri length",
	"sh:path": {
		"@id": "ex:uriLength"
	},
	"sh:values": {
		"sh:select": "\n\t\t\tSELECT (STRLEN(STR($this)) AS ?result)\n\t\t\tWHERE {\n\t\t\t}\n\t\t"
	}
}</code></pre>
						</div></aside></div>
					<p>
						Note that the query is executed with the current <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-focus-node">focus node</a> <a href="#dfn-pre-binding" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-pre-binding-13">pre-bound</a> to the variable <code>this</code>.
					</p>
				</aside>
			</section>
		</section>
		
		<div style="padding-top: 30px">
			<h1 id="appendix" style="font-size: 160%; font-weight: bold">Appendix</h1>
		</div>

		<section id="pre-binding" class="appendix"><div class="header-wrapper"><h2 id="a-pre-binding-of-variables-in-sparql-queries"><bdi class="secno">A. </bdi>Pre-binding of Variables in SPARQL Queries</h2><a class="self-link" href="#pre-binding" aria-label="Permalink for Appendix A."></a></div>
			
			<p>
				Some features of SHACL-SPARQL rely on the concept of <a href="#dfn-pre-binding" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-pre-binding-14">pre-binding of variables</a> as defined in this section.
			</p>
			<div class="syntax" data-syntax-rule="pre-binding-limitations" id="syntax-rule-pre-binding-limitations">
				<p>
					The definition of pre-binding used by SHACL requires the following restrictions on SPARQL queries.
					SHACL-SPARQL processors <em class="rfc2119">MUST</em> report a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-failure">failure</a> when it is operating on a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shapes-graph">shapes graph</a>
					that contains SHACL-SPARQL queries (via <code>sh:select</code> and <code>sh:ask</code>) that violate any of these restrictions.
					Note that the term <em>potentially pre-bound variables</em> includes the variables <code>this</code>,
					<code>shapesGraph</code>, <code>currentShape</code>, <code>value</code> (for ASK queries),
					and any variables that represent the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-parameter">parameters</a> of the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-constraint-component">constraint component</a> that uses the query.
					
				</p>
				<ul>
					<li>SPARQL queries must not contain a <code>MINUS</code> clause</li>
					<li>SPARQL queries must not contain a federated query (<code>SERVICE</code>)</li>
					<li>SPARQL queries must not contain a <code>VALUES</code> clause that mentions any potentially pre-bound variable</li>
					<li>SPARQL queries must not use the syntax form โโ<code>AS ?var</code> for any potentially pre-bound variable</li>
				</ul>
			</div>

			<div class="def def-text">
				<div class="def-header">DEFINITION: <dfn id="dfn-values-insertion" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">Values Insertion</dfn></div>
				<div class="def-text-body">
					<p>
						For solution mapping <code>ฮผ</code>, define <code>Table(ฮผ)</code> to be the multiset formed from <code>ฮผ</code>.
					</p>
					<p>
						&nbsp;&nbsp;&nbsp;<code>Table(ฮผ) = { ฮผ }</code><br>
						&nbsp;&nbsp;&nbsp;<code>Card[ฮผ] = 1</code>
					</p>
					<p>
						Define the <em>Values Insertion</em> function <code>Replace(X, ฮผ)</code> to
						replace each occurence <code>Y</code> of a 
						<a href="https://www.w3.org/TR/sparql12-query/#sparqlTranslateBasicGraphPatterns">Basic Graph Pattern</a>,
						<a href="https://www.w3.org/TR/sparql12-query/#sparqlTranslatePathExpressions">Property Path Expression</a>,
						<a href="https://www.w3.org/TR/sparql12-query/#sparqlTranslateGraphPatterns"><code>Graph(Var, pattern)</code></a>
						in <code>X</code> with <code>join(Y, Table(ฮผ))</code>.
					</p>
				</div>
			</div>

			<div class="def def-text">
				<div class="def-header">DEFINITION: <dfn data-lt="pre-binding|pre-bind|pre-bound|pre-bound variables|pre-binds|Pre-binding of variables" id="dfn-pre-binding" tabindex="0" aria-haspopup="dialog" data-dfn-type="dfn">Pre-binding of variables</dfn></div>
				<div class="def-text-body">
					<p>
						The evaluation of the <a href="https://www.w3.org/TR/sparql12-query/#idp2427544">SPARQL Query</a>
						<code>Q = (E, DS, QF)</code> with <em>pre-bound</em> variables <code>ฮผ</code>
						is defined as the evaluation of SPARQL query <code>Q' = (Replace(E, ฮผ), DS, QF)</code>.
					</p>
				</div>
			</div>

		</section>
		
		<section id="syntax-rules" class="appendix"><div class="header-wrapper"><h2 id="b-summary-of-shacl-syntax-rules"><bdi class="secno">B. </bdi>Summary of SHACL Syntax Rules</h2><a class="self-link" href="#syntax-rules" aria-label="Permalink for Appendix B."></a></div>
			
			<p>
				This section enumerates all normative syntax rules of SHACL.
				This section is automatically generated from other parts of this spec and hyperlinks are provided back
				into the prose if the context of the rule in unclear. 
				Nodes that violate these rules in a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shapes-graph">shapes graph</a> are <a href="#dfn-ill-formed" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-ill-formed-5">ill-formed</a>.
			</p>
			<table class="term-table" id="syntax-rules-table">
				<tbody><tr>
					<th>Syntax Rule Id</th>
					<th>Syntax Rule Text</th>
				</tr>
			</tbody><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-sparql-nodeKind">sparql-nodeKind</a></td><td>Shapes may have values for the property <code>sh:sparql</code>, and these values are either <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRIs</a> or <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-blank-node">blank nodes</a>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-SPARQLConstraint-select-count">SPARQLConstraint-select-count</a></td><td><a href="#dfn-sparql-based-constraint" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-15">SPARQL-based constraints</a> have exactly one <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> for the property <code>sh:select</code></td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-SPARQLConstraint-select-datatype">SPARQLConstraint-select-datatype</a></td><td>The value of <code>sh:select</code> is a <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-literal">literal</a> of datatype <code>xsd:string</code>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-select-query-valid">select-query-valid</a></td><td>Using the <a href="#sparql-prefixes">prefix handling rules</a>, the value of <code>sh:select</code> is a valid SPARQL 1.2 SELECT query.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-select-query-this">select-query-this</a></td><td>The SPARQL query derived from the value of <code>sh:select</code> <a href="https://www.w3.org/TR/sparql12-query/#selectproject">projects</a> the variable <code>this</code> in the SELECT clause.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-SPARQLConstraint-message-datatype">SPARQLConstraint-message-datatype</a></td><td><a href="#dfn-sparql-based-constraint" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-16">SPARQL-based constraints</a> may have values for the property <code>sh:message</code> and these are either <code>xsd:string</code> literals or literals with a language tag.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-SPARQLConstraint-deactivated-maxCount">SPARQLConstraint-deactivated-maxCount</a></td><td><a href="#dfn-sparql-based-constraint" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-17">SPARQL-based constraints</a> may have at most one value for the property <code>sh:deactivated</code></td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-PATH-position">PATH-position</a></td><td>The only legal use of the variable <code>PATH</code> in the SPARQL queries of <a href="#dfn-sparql-based-constraint" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-18">SPARQL-based constraints</a>
					and <a href="#dfn-select-based-validators" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-select-based-validators-6">SELECT-based validators</a> is in the
					<a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-predicate">predicate</a> position of a <a href="https://www.w3.org/TR/sparql12-query/#QSynTriples">triple pattern</a>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-declare-nodeKind">declare-nodeKind</a></td><td>The <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">values</a> of the property <code>sh:declare</code> are <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRIs</a> or <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-blank-node">blank nodes</a></td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-prefix-count">prefix-count</a></td><td><a href="#dfn-prefix-declaration" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-prefix-declaration-5">Prefix declarations</a> have exactly one value for the property <code>sh:prefix</code></td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-prefix-datatype">prefix-datatype</a></td><td>The values of <code>sh:prefix</code> are <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-literal">literals</a> of datatype <code>xsd:string</code>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-namespace-count">namespace-count</a></td><td><a href="#dfn-prefix-declaration" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-prefix-declaration-6">Prefix declarations</a> have exactly one value for the property <code>sh:namespace</code>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-namespace-datatype">namespace-datatype</a></td><td>The values of <code>sh:namespace</code> are <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-literal">literals</a> of datatype <code>xsd:anyURI</code>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-prefixes-nodeKind">prefixes-nodeKind</a></td><td>The values of <code>sh:prefixes</code> are either <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRIs</a> or <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-blank-node">blank nodes</a>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-prefixes-duplicates">prefixes-duplicates</a></td><td>A SHACL processor collects a set of prefix mappings as the union of all
						individual prefix mappings that are <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">values</a> of the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-sparql-property-path">SPARQL property path</a> <code>sh:prefixes/owl:imports*/sh:declare</code>
						of the <a href="#dfn-sparql-based-constraint" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-19">SPARQL-based constraint</a> or <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-validators">validator</a>.
						If such a collection of prefix declarations contains multiple different namespaces for the same <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> of <code>sh:prefix</code>,
						then the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shapes-graph">shapes graph</a> is <a href="#dfn-ill-formed" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-ill-formed-6">ill-formed</a>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-ConstraintComponent">ConstraintComponent</a></td><td>A <a href="#dfn-sparql-based-constraint-components" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-based-constraint-components-6">SPARQL-based constraint component</a> is an <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRI</a> that has <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shacl-type">SHACL type</a>
					<code>sh:ConstraintComponent</code> in the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shapes-graph">shapes graph</a>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-Parameter-predicate-count">Parameter-predicate-count</a></td><td>Each <a href="#dfn-parameter-declaration" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-parameter-declaration-7">parameter declaration</a> has exactly one value for the property <code>sh:path</code></td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-Parameter">Parameter</a></td><td>At <a href="#dfn-parameter-declaration" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-parameter-declaration-8">parameter declarations</a>, the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> of <code>sh:path</code> is an <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRI</a>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-parameter-name-VARNAME">parameter-name-VARNAME</a></td><td>Every <a href="#dfn-parameter-names" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-parameter-names-7">parameter name</a> is a valid <a href="https://www.w3.org/TR/sparql12-query/#rVARNAME">SPARQL VARNAME</a>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-parameter-name-not-in">parameter-name-not-in</a></td><td><a href="#dfn-parameter-names" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-parameter-names-8">Parameter names</a> must not be one of the following: <code>this</code>, <code>shapesGraph</code>, <code>currentShape</code>, <code>path</code>, <code>PATH</code>, <code>value</code>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-parameter-name-unique">parameter-name-unique</a></td><td>A constraint component where two or more <a href="#dfn-parameter-declaration" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-parameter-declaration-9">parameter declarations</a> use the same <a href="#dfn-parameter-names" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-parameter-names-9">parameter names</a> is <a href="#dfn-ill-formed" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-ill-formed-7">ill-formed</a>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-optional-datatype">optional-datatype</a></td><td>The values of <code>sh:optional</code> must be literals with datatype <code>xsd:boolean</code>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-optional-maxCount">optional-maxCount</a></td><td>A <a href="#dfn-parameter-declaration" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-parameter-declaration-10">parameter declaration</a> can have at most one value for the property <code>sh:optional</code>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-ConstraintComponent-parameter">ConstraintComponent-parameter</a></td><td>Every <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-constraint-component">constraint component</a> has at least one non-optional parameter.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-Parameter-conformance">Parameter-conformance</a></td><td>Shapes that do not <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-conform">conform</a> with the constraints declared for the parameters are <a href="#dfn-ill-formed" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-ill-formed-8">ill-formed</a>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-labelTemplate-datatype">labelTemplate-datatype</a></td><td>The values of <code>sh:labelTemplate</code> are strings (possibly with language tag)</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-nodeValidator-class">nodeValidator-class</a></td><td>The values of <code>sh:nodeValidator</code> must be <a href="#dfn-select-based-validators" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-select-based-validators-7">SELECT-based validators</a>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-propertyValidator-class">propertyValidator-class</a></td><td>The values of <code>sh:propertyValidator</code> must be <a href="#dfn-select-based-validators" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-select-based-validators-8">SELECT-based validators</a>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-SPARQLSelectValidator-select-count">SPARQLSelectValidator-select-count</a></td><td><a href="#dfn-select-based-validators" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-select-based-validators-9">SELECT-based validators</a> have exactly one <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> for the property <code>sh:select</code>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-validator-class">validator-class</a></td><td>The values of <code>sh:validator</code> must be <a href="#dfn-ask-based-validators" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-ask-based-validators-4">ASK-based validators</a>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-ask-count">ask-count</a></td><td><a href="#dfn-ask-based-validators" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-ask-based-validators-5">ASK-based validators</a> have exactly one value for the property <code>sh:ask</code></td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-ask-datatype">ask-datatype</a></td><td>The value of <code>sh:ask</code> must be a literal with datatype <code>xsd:string</code>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-ask-sparql">ask-sparql</a></td><td>The value of <code>sh:ask</code> must be a valid SPARQL ASK query using the aforementioned <a href="#sparql-prefixes">prefix handling rules</a>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-resultAnnotation-nodeKind">resultAnnotation-nodeKind</a></td><td>The <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">values</a> of <code>sh:resultAnnotation</code> are
				called <a href="#dfn-result-annotation" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-result-annotation-4">result annotations</a> and are either <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRIs</a> or <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-blank-node">blank nodes</a></td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-annotationProperty">annotationProperty</a></td><td>Each <a href="#dfn-result-annotation" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-result-annotation-5">result annotation</a> has exactly one <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a>
						for the property <code>sh:annotationProperty</code> and this value is an <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRI</a>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-annotationVarName">annotationVarName</a></td><td>Each <a href="#dfn-result-annotation" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-result-annotation-6">result annotation</a> has at most 1 <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a>
						for the property <code>sh:annotationVarName</code> and this <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> is <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-literal">literal</a> with
						<a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-datatype">datatype</a> <code>xsd:string</code>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-SelectExpression-syntax">SelectExpression-syntax</a></td><td>A node in an RDF graph is a <a href="#dfn-well-formed" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-well-formed-5">well-formed</a> <a href="#dfn-select-expression" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-select-expression-6">select expression</a> if it is a <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-blank-node">blank node</a>
					that has exactly one <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> for the <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-predicate">predicate</a> <code>sh:select</code>
					and this <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> is a <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-literal">literal</a> with <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-datatype">datatype</a> <code>xsd:string</code>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-SelectExpression-syntax-prefixes">SelectExpression-syntax-prefixes</a></td><td>A <a href="#dfn-well-formed" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-well-formed-6">well-formed</a> <a href="#dfn-select-expression" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-select-expression-7">select expression</a> can have at most one <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> for the property
					<code>sh:prefixes</code> and this value can only be an <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRI</a> or a <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-blank-node">blank node</a>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-SelectExpression-query-valid">SelectExpression-query-valid</a></td><td>Using the <a href="#sparql-prefixes">prefix handling rules</a>, the value of <code>sh:select</code> is a valid SPARQL 1.2 SELECT query.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-SelectExpression-query-output-nodes">SelectExpression-query-output-nodes</a></td><td>The SPARQL query derived from the value of <code>sh:select</code> <a href="https://www.w3.org/TR/sparql12-query/#selectproject">projects</a> exactly one variable in the SELECT clause.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-SPARQLExprExpression-syntax-eval">SPARQLExprExpression-syntax-eval</a></td><td>A node in an RDF graph
					is a <a href="#dfn-well-formed" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-well-formed-7">well-formed</a> <a href="#dfn-sparql-expr-expression" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-expr-expression-5">SPARQL expr expression</a> if it is a <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-blank-node">blank node</a>
					that has exactly one <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> for the <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-predicate">predicate</a> <code>sh:sparqlExpr</code>
					and that <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> is a <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-literal">literal</a> with <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-datatype">datatype</a> <code>xsd:string</code>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-SPARQLExprExpression-syntax-prefixes">SPARQLExprExpression-syntax-prefixes</a></td><td>A <a href="#dfn-well-formed" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-well-formed-8">well-formed</a> <a href="#dfn-sparql-expr-expression" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-sparql-expr-expression-6">SPARQL expr expression</a> can have at most one <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> for the property
					<code>sh:prefixes</code> and this value is an <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-iri">IRI</a> or a <a data-link-type="dfn" href="https://www.w3.org/TR/rdf12-concepts/#dfn-blank-node">blank node</a>.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-SPARQLExprExpression-template">SPARQLExprExpression-template</a></td><td>Let <code>$EXPR$</code> be the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-value">value</a> of <code>sh:eval</code> and <code>$PREFIXES$</code>
					be the SPARQL prefixes block resulting from the <a href="#sparql-prefixes">prefix handling rules</a> using the value of <code>sh:prefixes</code>;
					then <code>select</code> is defined as the string where <code>$EXPR$</code> and <code>$PREFIXES$</code> are inserted as into <br><br><code>$PREFIXES$ SELECT ($EXPR$ AS ?result) WHERE {}</code><br><br></td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-SPARQLExprExpression-query-valid">SPARQLExprExpression-query-valid</a></td><td><code>select</code> is a valid SPARQL 1.2 SELECT query.</td></tr><tr class="syntax-rule-tr"><td class="syntax-rule-id"><a class="syntax-rule-id-a" href="#syntax-rule-pre-binding-limitations">pre-binding-limitations</a></td><td>
				<p>
					The definition of pre-binding used by SHACL requires the following restrictions on SPARQL queries.
					SHACL-SPARQL processors <em class="rfc2119">MUST</em> report a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-failure">failure</a> when it is operating on a <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-shapes-graph">shapes graph</a>
					that contains SHACL-SPARQL queries (via <code>sh:select</code> and <code>sh:ask</code>) that violate any of these restrictions.
					Note that the term <em>potentially pre-bound variables</em> includes the variables <code>this</code>,
					<code>shapesGraph</code>, <code>currentShape</code>, <code>value</code> (for ASK queries),
					and any variables that represent the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-parameter">parameters</a> of the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-constraint-component">constraint component</a> that uses the query.
					
				</p>
				<ul>
					<li>SPARQL queries must not contain a <code>MINUS</code> clause</li>
					<li>SPARQL queries must not contain a federated query (<code>SERVICE</code>)</li>
					<li>SPARQL queries must not contain a <code>VALUES</code> clause that mentions any potentially pre-bound variable</li>
					<li>SPARQL queries must not use the syntax form โโ<code>AS ?var</code> for any potentially pre-bound variable</li>
				</ul>
			</td></tr></table>
		</section>
		
		<section id="sparql-definitions-core" class="appendix informative"><div class="header-wrapper"><h2 id="c-potential-sparql-definitions-of-shacl-core-constraint-validators"><bdi class="secno">C. </bdi>Potential SPARQL Definitions of SHACL Core Constraint Validators</h2><a class="self-link" href="#sparql-definitions-core" aria-label="Permalink for Appendix C."></a></div><p><em>This section is non-normative.</em></p>
			
			<p>
				This appendix uses parts of SPARQL 1.2 in non-normative alternative definitions of the semantics of <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-constraint-component">constraint components</a> and <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-target">targets</a>
				from [<cite><a class="bibref" data-link-type="biblio" href="#bib-shacl12-core" title="SHACL 1.2 Core">shacl12-core</a></cite>].
				While these may help some implementers, SPARQL is not required for the implementation of the SHACL Core language.
			</p>
			<p>
				SPARQL variables using the <code>$</code> marker represent external <a href="#dfn-bindings" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-bindings-7">bindings</a> that are <a href="#dfn-pre-binding" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-pre-binding-15">pre-bound</a> or, in the case of <code>$PATH</code>, <a href="#dfn-substituted" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-substituted-3">substituted</a> in the SPARQL query before execution (as explained in <a href="#constraint-components-validation" class="sec-ref"><bdi class="secno">3.3 </bdi>Validation with SPARQL-based Constraint Components</a>).
				<span class="todo">TODO: Assuming SHACL Core 1.2 allows node expressions as constraint parameters, explain that they are evaluated prior to substitution.</span>
			</p>
			<section id="sparql-definition-targetClass"><div class="header-wrapper"><h3 id="c-1-sh-targetclass"><bdi class="secno">C.1 </bdi>sh:targetClass</h3><a class="self-link" href="#sparql-definition-targetClass" aria-label="Permalink for Appendix C.1"></a></div>
				
				<p class="def-sparql">
					The following query expresses a potential definition of <a href="https://www.w3.org/TR/shacl12-core/#targetClass">class targets</a> in SPARQL.
					The variable <code>targetClass</code> will be <a href="#dfn-pre-binding" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-pre-binding-16">pre-bound</a> to the given value of <code>sh:targetClass</code>.
					All <a href="#dfn-bindings" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-bindings-8">bindings</a> of the variable <code>this</code> from the <a href="#dfn-solutions" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-solutions-14">solutions</a> become focus nodes.
				</p>
				<div class="def def-sparql">
					<div class="def-header">POTENTIAL DEFINITION IN SPARQL</div>
<pre class="def-sparql-body" aria-busy="false"><code class="hljs">SELECT DISTINCT ?this    # ?this is the focus node
WHERE {
	?this rdf:type/rdfs:subClassOf* $targetClass .
}</code></pre>
				</div>
			</section>
			<section id="sparql-definition-targetSubjectsOf"><div class="header-wrapper"><h3 id="c-2-sh-targetsubjectsof"><bdi class="secno">C.2 </bdi>sh:targetSubjectsOf</h3><a class="self-link" href="#sparql-definition-targetSubjectsOf" aria-label="Permalink for Appendix C.2"></a></div>
				
				<p class="def-sparql">
					The following query expresses a potential definition of <a href="https://www.w3.org/TR/shacl12-core/#targetSubjectsOf">subjects-of targets</a> in SPARQL.
					The variable <code>targetSubjectsOf</code> will be <a href="#dfn-pre-binding" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-pre-binding-17">pre-bound</a> to the given value of <code>sh:targetSubjectsOf</code>.
					All <a href="#dfn-bindings" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-bindings-9">bindings</a> of the variable <code>this</code> from the <a href="#dfn-solutions" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-solutions-15">solutions</a> become focus nodes.
				</p>
				<div class="def def-sparql">
					<div class="def-header">POTENTIAL DEFINITION IN SPARQL</div>
<pre class="def-sparql-body" aria-busy="false"><code class="hljs">SELECT DISTINCT ?this    # ?this is the focus node
WHERE {
	?this $targetSubjectsOf ?any .
}</code></pre>
				</div>
			</section>
			<section id="sparql-definition-targetObjectsOf"><div class="header-wrapper"><h3 id="c-3-sh-targetobjectsof"><bdi class="secno">C.3 </bdi>sh:targetObjectsOf</h3><a class="self-link" href="#sparql-definition-targetObjectsOf" aria-label="Permalink for Appendix C.3"></a></div>
					
				<p class="def-sparql">
					The following query expresses a potential definition of <a href="https://www.w3.org/TR/shacl12-core/#targetObjectsOf">objects-of targets</a> in SPARQL.
					The variable <code>targetObjectsOf</code> will be <a href="#dfn-pre-binding" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-pre-binding-18">pre-bound</a> to the given value of <code>sh:targetObjectsOf</code>.
					All <a href="#dfn-bindings" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-bindings-10">bindings</a> of the variable <code>this</code> from the <a href="#dfn-solutions" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-solutions-16">solutions</a> become focus nodes.
				</p>
				<div class="def def-sparql">
					<div class="def-header">POTENTIAL DEFINITION IN SPARQL</div>
<pre class="def-sparql-body" aria-busy="false"><code class="hljs">SELECT DISTINCT ?this    # ?this is the focus node
WHERE {
	?any $targetObjectsOf ?this .
}</code></pre>
				</div>
			</section>
			<section id="sparql-definition-class"><div class="header-wrapper"><h3 id="c-4-sh-class"><bdi class="secno">C.4 </bdi>sh:class</h3><a class="self-link" href="#sparql-definition-class" aria-label="Permalink for Appendix C.4"></a></div>
				
				<p class="def-sparql">
					The following query expresses a potential SPARQL-based validator for <a href="https://www.w3.org/TR/shacl12-core/#ClassConstraintComponent">sh:class</a>.
				</p>
				<div class="def def-sparql">
					<div class="def-header">POTENTIAL DEFINITION IN SPARQL (Must evaluate to true for each value node $value)</div>
<pre class="def-sparql-body" aria-busy="false"><code class="hljs">ASK {
	$value rdf:type/rdfs:subClassOf* $class .
}</code></pre>
				</div>
			</section>
			<section id="sparql-definition-nodeKind"><div class="header-wrapper"><h3 id="c-5-sh-nodekind"><bdi class="secno">C.5 </bdi>sh:nodeKind</h3><a class="self-link" href="#sparql-definition-nodeKind" aria-label="Permalink for Appendix C.5"></a></div>
				
				<p class="def-sparql">
					The following query expresses a potential SPARQL-based validator for <a href="https://www.w3.org/TR/shacl12-core/#NodeKindConstraintComponent">sh:nodeKind</a>.
				</p>
				<div class="def def-sparql">
					<div class="def-header">POTENTIAL DEFINITION IN SPARQL (Must evaluate to true for each value node $value)</div>
<pre class="def-sparql-body" aria-busy="false"><code class="hljs">ASK {
	FILTER ((isIRI($value) &amp;&amp; $nodeKind IN ( sh:IRI, sh:BlankNodeOrIRI, sh:IRIOrLiteral ) ) ||
		(isLiteral($value) &amp;&amp; $nodeKind IN ( sh:Literal, sh:BlankNodeOrLiteral, sh:IRIOrLiteral ) ) ||
		(isBlank($value)   &amp;&amp; $nodeKind IN ( sh:BlankNode, sh:BlankNodeOrIRI, sh:BlankNodeOrLiteral ) )) .
}</code></pre>
				</div>
			</section>
			<section id="sparql-definition-minExclusive"><div class="header-wrapper"><h3 id="c-6-sh-minexclusive-etc"><bdi class="secno">C.6 </bdi>sh:minExclusive (etc)</h3><a class="self-link" href="#sparql-definition-minExclusive" aria-label="Permalink for Appendix C.6"></a></div>
				
				<p>
					The following query expresses a potential SPARQL-based validator for <a href="https://www.w3.org/TR/shacl12-core/#MinExclusiveConstraintComponent">sh:minExclusive</a>.
					The SPARQL expression produces an error if the value node cannot be compared to the specified range,
					for example when someone compares a string with an integer.
					If the comparison cannot be performed, then there is a validation result.
					This is different from, say, a plain SPARQL query, in which such errors would silently not lead to any results.
				</p>
				<div class="def def-sparql">
					<div class="def-header">POTENTIAL DEFINITION IN SPARQL (Must evaluate to true for each value node $value)</div>
<pre class="def-sparql-body" aria-busy="false"><code class="hljs">ASK {
	FILTER ($minExclusive &lt; $value)
}</code></pre>
				</div>
				<p>
					Similar definitions are possible for:
				</p>
				<ul>
					<li><a href="https://www.w3.org/TR/shacl12-core/#MinInclusiveConstraintComponent">sh:minInclusive</a>: &lt;=</li>
					<li><a href="https://www.w3.org/TR/shacl12-core/#MaxExclusiveConstraintComponent">sh:maxExclusive</a>: &gt;</li>
					<li><a href="https://www.w3.org/TR/shacl12-core/#MaxInclusiveConstraintComponent">sh:maxInclusive</a>: &gt;=</li>
				</ul>
			</section>
			<section id="sparql-definition-minLength"><div class="header-wrapper"><h3 id="c-7-sh-minlength"><bdi class="secno">C.7 </bdi>sh:minLength</h3><a class="self-link" href="#sparql-definition-minLength" aria-label="Permalink for Appendix C.7"></a></div>
				
				<p>
					The following query expresses a potential SPARQL-based validator for <a href="https://www.w3.org/TR/shacl12-core/#MinLengthConstraintComponent">sh:minLength</a>.
				</p>
				<div class="def def-sparql">
					<div class="def-header">POTENTIAL DEFINITION IN SPARQL (Must evaluate to true for each value node $value)</div>
<pre class="def-sparql-body" aria-busy="false"><code class="hljs">ASK {
	FILTER (STRLEN(str($value)) &gt;= $minLength) .
}</code></pre>
				</div>
			</section>
			<section id="sparql-definition-maxLength"><div class="header-wrapper"><h3 id="c-8-sh-maxlength"><bdi class="secno">C.8 </bdi>sh:maxLength</h3><a class="self-link" href="#sparql-definition-maxLength" aria-label="Permalink for Appendix C.8"></a></div>
				
				<p>
					The following query expresses a potential SPARQL-based validator for <a href="https://www.w3.org/TR/shacl12-core/#MaxLengthConstraintComponent">sh:maxLength</a>.
				</p>
				<div class="def def-sparql">
					<div class="def-header">POTENTIAL DEFINITION IN SPARQL (Must evaluate to true for each value node $value)</div>
<pre class="def-sparql-body" aria-busy="false"><code class="hljs">ASK {
	FILTER (STRLEN(str($value)) &lt;= $maxLength) .
}</code></pre>
				</div>
			</section>
			<section id="sparql-definition-pattern"><div class="header-wrapper"><h3 id="c-9-sh-pattern"><bdi class="secno">C.9 </bdi>sh:pattern</h3><a class="self-link" href="#sparql-definition-pattern" aria-label="Permalink for Appendix C.9"></a></div>
				
				<p>
					The following query expresses a potential SPARQL-based validator for <a href="https://www.w3.org/TR/shacl12-core/#PatternConstraintComponent">sh:pattern</a>.
				</p>
				<div class="def def-sparql">
					<div class="def-header">POTENTIAL DEFINITION IN SPARQL (Must evaluate to true for each value node $value)</div>
<pre class="def-sparql-body" aria-busy="false"><code class="hljs">ASK {
	FILTER (!isBlank($value) &amp;&amp; IF(bound($flags), regex(str($value), $pattern, $flags), regex(str($value), $pattern)))
}</code></pre>
				</div>
			</section>
			<section id="sparql-definition-disjoint"><div class="header-wrapper"><h3 id="c-10-sh-disjoint"><bdi class="secno">C.10 </bdi>sh:disjoint</h3><a class="self-link" href="#sparql-definition-disjoint" aria-label="Permalink for Appendix C.10"></a></div>
				
				<p>
					The following query expresses a potential SPARQL-based validator for <a href="https://www.w3.org/TR/shacl12-core/#DisjointConstraintComponent">sh:disjoint</a>.
				</p>
				<div class="def def-sparql">
					<div class="def-header">POTENTIAL DEFINITION IN SPARQL (Must return no results for the given $PATH)</div>
<pre class="def-sparql-body" aria-busy="false"><code class="hljs">SELECT DISTINCT $this ?value
WHERE {
	$this $PATH ?value .
	$this $disjoint ?value .
}</code></pre>
				</div>
			</section>
			<section id="sparql-definition-lessThan"><div class="header-wrapper"><h3 id="c-11-sh-lessthan"><bdi class="secno">C.11 </bdi>sh:lessThan</h3><a class="self-link" href="#sparql-definition-lessThan" aria-label="Permalink for Appendix C.11"></a></div>
				
				<p>
					The following query expresses a potential SPARQL-based validator for <a href="https://www.w3.org/TR/shacl12-core/#LessThanConstraintComponent">sh:lessThan</a>.
				</p>
				<div class="def def-sparql">
					<div class="def-header">POTENTIAL DEFINITION IN SPARQL (Must return no results for the given $PATH)</div>
<pre class="def-sparql-body" aria-busy="false"><code class="hljs">SELECT $this ?value
WHERE {
	$this $PATH ?value .
	$this $lessThan ?otherValue .
	BIND (?value &lt; ?otherValue AS ?result) .
	FILTER (!bound(?result) || !(?result)) .
}</code></pre>
				</div>
			</section>
			<section id="sparql-definition-lessThanOrEquals"><div class="header-wrapper"><h3 id="c-12-sh-lessthanorequals"><bdi class="secno">C.12 </bdi>sh:lessThanOrEquals</h3><a class="self-link" href="#sparql-definition-lessThanOrEquals" aria-label="Permalink for Appendix C.12"></a></div>
				
				<p>
					The following query expresses a potential SPARQL-based validator for <a href="https://www.w3.org/TR/shacl12-core/#LessThanConstraintComponent">sh:lessThanOrEquals</a>.
				</p>
				<div class="def def-sparql">
					<div class="def-header">POTENTIAL DEFINITION IN SPARQL (Must return no results for the given $PATH)</div>
<pre class="def-sparql-body" aria-busy="false"><code class="hljs">SELECT $this ?value
WHERE {
	$this $PATH ?value .
	$this $lessThanOrEquals ?otherValue .
	BIND (?value &lt;= ?otherValue AS ?result) .
	FILTER (!bound(?result) || !(?result)) .
}</code></pre>
				</div>
			</section>
			<section id="sparql-definition-in"><div class="header-wrapper"><h3 id="c-13-sh-in"><bdi class="secno">C.13 </bdi>sh:in</h3><a class="self-link" href="#sparql-definition-in" aria-label="Permalink for Appendix C.13"></a></div>
				
				<p>
					The following query expresses a potential SPARQL-based validator for <a href="https://www.w3.org/TR/shacl12-core/#InConstraintComponent">sh:in</a>.
				</p>
				<div class="def def-sparql">
					<div class="def-header">POTENTIAL DEFINITION IN SPARQL (Must evaluate to true for each value node $value)</div>
<pre class="def-sparql-body" aria-busy="false"><code class="hljs">ASK {
	GRAPH $shapesGraph {
		$in (rdf:rest*)/rdf:first $value .
	}
}</code></pre>
				</div>
			</section>
		</section>
		
		<section id="security" class="appendix informative"><div class="header-wrapper"><h2 id="d-security-and-privacy-considerations"><bdi class="secno">D. </bdi>Security and Privacy Considerations</h2><a class="self-link" href="#security" aria-label="Permalink for Appendix D."></a></div><p><em>This section is non-normative.</em></p>
			
			<p>
				Like most RDF-based technologies, SHACL processors may operate on graphs that are combined
				from various sources.  Some applications may have an open "linked data" architecture and dynamically
				assemble RDF triples from sources that are outside of an organization's network of trust.
				Since RDF allows anyone to add statements about any resource, triples may modify the originally
				intended semantics of shape definitions or nodes in a data graph and thus lead to misleading results.
				Protection against this (and the following) scenario can be achieved by only using trusted
				and verified RDF sources and eliminating the possibility that graphs are dynamically added via
				<code>owl:imports</code> and <code>sh:shapesGraph</code>.
			</p>
			<p>
				SHACL-SPARQL includes all the <a href="https://www.w3.org/TR/sparql12-query/#security">security issues of SPARQL</a>.
			</p>
		</section>
		
		<section id="ack" class="appendix informative"><div class="header-wrapper"><h2 id="e-acknowledgements"><bdi class="secno">E. </bdi>Acknowledgements</h2><a class="self-link" href="#ack" aria-label="Permalink for Appendix E."></a></div><p><em>This section is non-normative.</em></p>
			
			<p>
				The original 1.0 version of SHACL was produced by the RDF Data Shapes Working Group.
				See its <a href="https://www.w3.org/TR/shacl/#ack">SHACL 1.0 Acknowledgements section</a>.
			</p>
		</section>

		<section class="appendix informative" id="revision-history"><div class="header-wrapper"><h2 id="f-revision-history"><bdi class="secno">F. </bdi>Revision History</h2><a class="self-link" href="#revision-history" aria-label="Permalink for Appendix F."></a></div><p><em>This section is non-normative.</em></p>
			
			  <p>
				  The detailed list of changes and their diffs can be found in the Git repository.
			  </p>
			  <ul>
				  <li><b>2024-02-14</b>: New work started by cloning the main SHACL spec and splitting it into SHACL Core and SHACL-SPARQL</li>
			  </ul>
		</section>

		<section class="appendix informative" id="changes-12"><div class="header-wrapper"><h2 id="g-changes-between-shacl-1-0-sparql-and-shacl-1-2-sparql-extensions"><bdi class="secno">G. </bdi>Changes between SHACL 1.0 SPARQL and SHACL 1.2 SPARQL Extensions</h2><a class="self-link" href="#changes-12" aria-label="Permalink for Appendix G."></a></div><p><em>This section is non-normative.</em></p>
			
			<ul>
				<li>Added the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-node-expression-function">node expression function</a> <a href="#SelectExpression"><code>sh:SelectExpression</code></a>, see <a href="https://github.com/w3c/data-shapes/issues/288">Issue 288</a></li>
				<li>Added support for <a href="#dfn-annotation-properties" class="internalDFN" data-link-type="dfn" id="ref-for-dfn-annotation-properties-1">annotation properties</a>, see <a href="https://github.com/w3c/data-shapes/issues/327">Issue 327</a></li>
				<li>Added the <a data-link-type="dfn" href="https://www.w3.org/TR/shacl12-core/#dfn-node-expression-function">node expression function</a> <a href="#SPARQLExprExpression"><code>sh:SPARQLExprExpression</code></a>, see <a href="https://github.com/w3c/data-shapes/issues/315">Issue 315</a></li>
				<li>Clarified that VALUES clauses are only disallowed when they mention <a href="#pre-binding">pre-bound variables</a> and removed the restriction on sub-SELECTs, see <a href="https://github.com/w3c/data-shapes/issues/159">Issue 159</a></li>
			</ul>
		</section>		
		  
	


<section id="references" class="appendix"><div class="header-wrapper"><h2 id="h-references"><bdi class="secno">H. </bdi>References</h2><a class="self-link" href="#references" aria-label="Permalink for Appendix H."></a></div><section id="normative-references"><div class="header-wrapper"><h3 id="h-1-normative-references"><bdi class="secno">H.1 </bdi>Normative references</h3><a class="self-link" href="#normative-references" aria-label="Permalink for Appendix H.1"></a></div>
    
    <dl class="bibliography"><dt id="bib-rdf12-concepts">[rdf12-concepts]</dt><dd>
      <a href="https://www.w3.org/TR/rdf12-concepts/"><cite>RDF 1.2 Concepts and Abstract Syntax</cite></a>. Olaf Hartig; Pierre-Antoine Champin; Gregg Kellogg; Andy Seaborne.  W3C. 4 July 2025. W3C Working Draft. URL: <a href="https://www.w3.org/TR/rdf12-concepts/">https://www.w3.org/TR/rdf12-concepts/</a>
    </dd><dt id="bib-rdf12-turtle">[rdf12-turtle]</dt><dd>
      <a href="https://www.w3.org/TR/rdf12-turtle/"><cite>RDF 1.2 Turtle</cite></a>. Gregg Kellogg; Dominik Tomaszuk.  W3C. 2 July 2025. W3C Working Draft. URL: <a href="https://www.w3.org/TR/rdf12-turtle/">https://www.w3.org/TR/rdf12-turtle/</a>
    </dd><dt id="bib-rec-xml-names">[REC-xml-names]</dt><dd>
      <a href="https://www.w3.org/TR/xml-names/"><cite>Namespaces in XML 1.0 (Third Edition)</cite></a>. Tim Bray; Dave Hollander; Andrew Layman; Richard Tobin; Henry Thompson et al.  W3C. 8 December 2009. W3C Recommendation. URL: <a href="https://www.w3.org/TR/xml-names/">https://www.w3.org/TR/xml-names/</a>
    </dd><dt id="bib-rfc2119">[RFC2119]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. S. Bradner.  IETF. March 1997. Best Current Practice. URL: <a href="https://www.rfc-editor.org/rfc/rfc2119">https://www.rfc-editor.org/rfc/rfc2119</a>
    </dd><dt id="bib-rfc8174">[RFC8174]</dt><dd>
      <a href="https://www.rfc-editor.org/rfc/rfc8174"><cite>Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words</cite></a>. B. Leiba.  IETF. May 2017. Best Current Practice. URL: <a href="https://www.rfc-editor.org/rfc/rfc8174">https://www.rfc-editor.org/rfc/rfc8174</a>
    </dd><dt id="bib-shacl12-core">[shacl12-core]</dt><dd>
      <a href="https://www.w3.org/TR/shacl12-core/"><cite>SHACL 1.2 Core</cite></a>. Holger Knublauch; Thomas Bergwinkl; Yousouf Taghzouti; Simon Werner.  W3C. 18 March 2025. FPWD. URL: <a href="https://www.w3.org/TR/shacl12-core/">https://www.w3.org/TR/shacl12-core/</a>
    </dd><dt id="bib-sparql12-query">[sparql12-query]</dt><dd>
      <a href="https://www.w3.org/TR/sparql12-query/"><cite>SPARQL 1.2 Query Language</cite></a>. Olaf Hartig; Andy Seaborne; Ruben Taelman; Gregory Williams; Thomas Pellissier Tanon.  W3C. 3 July 2025. W3C Working Draft. URL: <a href="https://www.w3.org/TR/sparql12-query/">https://www.w3.org/TR/sparql12-query/</a>
    </dd><dt id="bib-vc-data-model">[vc-data-model]</dt><dd>
      <a href="https://www.w3.org/TR/vc-data-model/"><cite>Verifiable Credentials Data Model v1.1</cite></a>. Manu Sporny; Grant Noble; Dave Longley; Daniel Burnett; Brent Zundel; Kyle Den Hartog.  W3C. 3 March 2022. W3C Recommendation. URL: <a href="https://www.w3.org/TR/vc-data-model/">https://www.w3.org/TR/vc-data-model/</a>
    </dd></dl>
  </section></section><p role="navigation" id="back-to-top">
    <a href="#title"><abbr title="Back to Top">โ</abbr></a>
  </p><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-bindings" aria-label="Links in this document to definition: binding">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-bindings" aria-label="Permalink for definition: binding. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-bindings-1" title="ยง 1.2 Document Conventions">ยง 1.2 Document Conventions</a> 
    </li><li>
      <a href="#ref-for-dfn-bindings-2" title="ยง 2.1 An Example SPARQL-based Constraint">ยง 2.1 An Example SPARQL-based Constraint</a> 
    </li><li>
      <a href="#ref-for-dfn-bindings-3" title="ยง 2.3 Validation with SPARQL-based Constraints">ยง 2.3 Validation with SPARQL-based Constraints</a> <a href="#ref-for-dfn-bindings-4" title="Reference 2">(2)</a> 
    </li><li>
      <a href="#ref-for-dfn-bindings-5" title="ยง 4. Annotation Properties">ยง 4. Annotation Properties</a> <a href="#ref-for-dfn-bindings-6" title="Reference 2">(2)</a> 
    </li><li>
      <a href="#ref-for-dfn-bindings-7" title="ยง C. Potential SPARQL Definitions of SHACL Core Constraint Validators">ยง C. Potential SPARQL Definitions of SHACL Core Constraint Validators</a> 
    </li><li>
      <a href="#ref-for-dfn-bindings-8" title="ยง C.1 sh:targetClass">ยง C.1 sh:targetClass</a> 
    </li><li>
      <a href="#ref-for-dfn-bindings-9" title="ยง C.2 sh:targetSubjectsOf">ยง C.2 sh:targetSubjectsOf</a> 
    </li><li>
      <a href="#ref-for-dfn-bindings-10" title="ยง C.3 sh:targetObjectsOf">ยง C.3 sh:targetObjectsOf</a> 
    </li>
  </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-solutions" aria-label="Links in this document to definition: solution">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-solutions" aria-label="Permalink for definition: solution. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-solutions-1" title="ยง 2.1 An Example SPARQL-based Constraint">ยง 2.1 An Example SPARQL-based Constraint</a> <a href="#ref-for-dfn-solutions-2" title="Reference 2">(2)</a> 
    </li><li>
      <a href="#ref-for-dfn-solutions-3" title="ยง 2.3 Validation with SPARQL-based Constraints">ยง 2.3 Validation with SPARQL-based Constraints</a> <a href="#ref-for-dfn-solutions-4" title="Reference 2">(2)</a> 
    </li><li>
      <a href="#ref-for-dfn-solutions-5" title="ยง 3.3 Validation with SPARQL-based Constraint Components">ยง 3.3 Validation with SPARQL-based Constraint Components</a> <a href="#ref-for-dfn-solutions-6" title="Reference 2">(2)</a> <a href="#ref-for-dfn-solutions-7" title="Reference 3">(3)</a> <a href="#ref-for-dfn-solutions-8" title="Reference 4">(4)</a> <a href="#ref-for-dfn-solutions-9" title="Reference 5">(5)</a> 
    </li><li>
      <a href="#ref-for-dfn-solutions-10" title="ยง 4. Annotation Properties">ยง 4. Annotation Properties</a> <a href="#ref-for-dfn-solutions-11" title="Reference 2">(2)</a> <a href="#ref-for-dfn-solutions-12" title="Reference 3">(3)</a> <a href="#ref-for-dfn-solutions-13" title="Reference 4">(4)</a> 
    </li><li>
      <a href="#ref-for-dfn-solutions-14" title="ยง C.1 sh:targetClass">ยง C.1 sh:targetClass</a> 
    </li><li>
      <a href="#ref-for-dfn-solutions-15" title="ยง C.2 sh:targetSubjectsOf">ยง C.2 sh:targetSubjectsOf</a> 
    </li><li>
      <a href="#ref-for-dfn-solutions-16" title="ยง C.3 sh:targetObjectsOf">ยง C.3 sh:targetObjectsOf</a> 
    </li>
  </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-ill-formed" aria-label="Links in this document to definition: ill-formed">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-ill-formed" aria-label="Permalink for definition: ill-formed. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-ill-formed-1" title="ยง 2.2 Syntax of SPARQL-based Constraints">ยง 2.2 Syntax of SPARQL-based Constraints</a> 
    </li><li>
      <a href="#ref-for-dfn-ill-formed-2" title="ยง 2.2.1 Prefix Declarations for SPARQL Queries">ยง 2.2.1 Prefix Declarations for SPARQL Queries</a> 
    </li><li>
      <a href="#ref-for-dfn-ill-formed-3" title="ยง 3.2.1 Parameter Declarations (sh:parameter)">ยง 3.2.1 Parameter Declarations (sh:parameter)</a> <a href="#ref-for-dfn-ill-formed-4" title="Reference 2">(2)</a> 
    </li><li>
      <a href="#ref-for-dfn-ill-formed-5" title="ยง B. Summary of SHACL Syntax Rules">ยง B. Summary of SHACL Syntax Rules</a> <a href="#ref-for-dfn-ill-formed-6" title="Reference 2">(2)</a> <a href="#ref-for-dfn-ill-formed-7" title="Reference 3">(3)</a> <a href="#ref-for-dfn-ill-formed-8" title="Reference 4">(4)</a> 
    </li>
  </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-well-formed" aria-label="Links in this document to definition: well-formed">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-well-formed" aria-label="Permalink for definition: well-formed. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-well-formed-1" title="ยง 5.1 Select Expressions">ยง 5.1 Select Expressions</a> <a href="#ref-for-dfn-well-formed-2" title="Reference 2">(2)</a> 
    </li><li>
      <a href="#ref-for-dfn-well-formed-3" title="ยง 5.2 SPARQL Expr Expressions">ยง 5.2 SPARQL Expr Expressions</a> <a href="#ref-for-dfn-well-formed-4" title="Reference 2">(2)</a> 
    </li><li>
      <a href="#ref-for-dfn-well-formed-5" title="ยง B. Summary of SHACL Syntax Rules">ยง B. Summary of SHACL Syntax Rules</a> <a href="#ref-for-dfn-well-formed-6" title="Reference 2">(2)</a> <a href="#ref-for-dfn-well-formed-7" title="Reference 3">(3)</a> <a href="#ref-for-dfn-well-formed-8" title="Reference 4">(4)</a> 
    </li>
  </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-sparql-based-constraint" aria-label="Links in this document to definition: SPARQL-based constraints">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-sparql-based-constraint" aria-label="Permalink for definition: SPARQL-based constraints. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-sparql-based-constraint-1" title="ยง 2. SPARQL-based Constraints">ยง 2. SPARQL-based Constraints</a> 
    </li><li>
      <a href="#ref-for-dfn-sparql-based-constraint-2" title="ยง 2.1 An Example SPARQL-based Constraint">ยง 2.1 An Example SPARQL-based Constraint</a> 
    </li><li>
      <a href="#ref-for-dfn-sparql-based-constraint-3" title="ยง 2.2 Syntax of SPARQL-based Constraints">ยง 2.2 Syntax of SPARQL-based Constraints</a> <a href="#ref-for-dfn-sparql-based-constraint-4" title="Reference 2">(2)</a> <a href="#ref-for-dfn-sparql-based-constraint-5" title="Reference 3">(3)</a> <a href="#ref-for-dfn-sparql-based-constraint-6" title="Reference 4">(4)</a> 
    </li><li>
      <a href="#ref-for-dfn-sparql-based-constraint-7" title="ยง 2.2.1 Prefix Declarations for SPARQL Queries">ยง 2.2.1 Prefix Declarations for SPARQL Queries</a> <a href="#ref-for-dfn-sparql-based-constraint-8" title="Reference 2">(2)</a> 
    </li><li>
      <a href="#ref-for-dfn-sparql-based-constraint-9" title="ยง 2.3 Validation with SPARQL-based Constraints">ยง 2.3 Validation with SPARQL-based Constraints</a> <a href="#ref-for-dfn-sparql-based-constraint-10" title="Reference 2">(2)</a> 
    </li><li>
      <a href="#ref-for-dfn-sparql-based-constraint-11" title="ยง 2.3.1 Pre-bound Variables in SPARQL Constraints ($this, $shapesGraph, $currentShape)">ยง 2.3.1 Pre-bound Variables in SPARQL Constraints ($this, $shapesGraph, $currentShape)</a> 
    </li><li>
      <a href="#ref-for-dfn-sparql-based-constraint-12" title="ยง 2.3.2 Mapping of Solution Bindings to Result Properties">ยง 2.3.2 Mapping of Solution Bindings to Result Properties</a> <a href="#ref-for-dfn-sparql-based-constraint-13" title="Reference 2">(2)</a> 
    </li><li>
      <a href="#ref-for-dfn-sparql-based-constraint-14" title="ยง 3. SPARQL-based Constraint Components">ยง 3. SPARQL-based Constraint Components</a> 
    </li><li>
      <a href="#ref-for-dfn-sparql-based-constraint-15" title="ยง B. Summary of SHACL Syntax Rules">ยง B. Summary of SHACL Syntax Rules</a> <a href="#ref-for-dfn-sparql-based-constraint-16" title="Reference 2">(2)</a> <a href="#ref-for-dfn-sparql-based-constraint-17" title="Reference 3">(3)</a> <a href="#ref-for-dfn-sparql-based-constraint-18" title="Reference 4">(4)</a> <a href="#ref-for-dfn-sparql-based-constraint-19" title="Reference 5">(5)</a> 
    </li>
  </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-prefix-declaration" aria-label="Links in this document to definition: prefix declarations">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-prefix-declaration" aria-label="Permalink for definition: prefix declarations. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-prefix-declaration-1" title="ยง 2.2.1 Prefix Declarations for SPARQL Queries">ยง 2.2.1 Prefix Declarations for SPARQL Queries</a> <a href="#ref-for-dfn-prefix-declaration-2" title="Reference 2">(2)</a> <a href="#ref-for-dfn-prefix-declaration-3" title="Reference 3">(3)</a> <a href="#ref-for-dfn-prefix-declaration-4" title="Reference 4">(4)</a> 
    </li><li>
      <a href="#ref-for-dfn-prefix-declaration-5" title="ยง B. Summary of SHACL Syntax Rules">ยง B. Summary of SHACL Syntax Rules</a> <a href="#ref-for-dfn-prefix-declaration-6" title="Reference 2">(2)</a> 
    </li>
  </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-substituted" aria-label="Links in this document to definition: substitute">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-substituted" aria-label="Permalink for definition: substitute. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-substituted-1" title="ยง 1.2 Document Conventions">ยง 1.2 Document Conventions</a> 
    </li><li>
      <a href="#ref-for-dfn-substituted-2" title="ยง 3.3 Validation with SPARQL-based Constraint Components">ยง 3.3 Validation with SPARQL-based Constraint Components</a> 
    </li><li>
      <a href="#ref-for-dfn-substituted-3" title="ยง C. Potential SPARQL Definitions of SHACL Core Constraint Validators">ยง C. Potential SPARQL Definitions of SHACL Core Constraint Validators</a> 
    </li>
  </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-sparql-based-constraint-components" aria-label="Links in this document to definition: SPARQL-based constraint component">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-sparql-based-constraint-components" aria-label="Permalink for definition: SPARQL-based constraint component. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-sparql-based-constraint-components-1" title="ยง 2.3.1 Pre-bound Variables in SPARQL Constraints ($this, $shapesGraph, $currentShape)">ยง 2.3.1 Pre-bound Variables in SPARQL Constraints ($this, $shapesGraph, $currentShape)</a> 
    </li><li>
      <a href="#ref-for-dfn-sparql-based-constraint-components-2" title="ยง 2.3.2 Mapping of Solution Bindings to Result Properties">ยง 2.3.2 Mapping of Solution Bindings to Result Properties</a> <a href="#ref-for-dfn-sparql-based-constraint-components-3" title="Reference 2">(2)</a> 
    </li><li>
      <a href="#ref-for-dfn-sparql-based-constraint-components-4" title="ยง 3. SPARQL-based Constraint Components">ยง 3. SPARQL-based Constraint Components</a> 
    </li><li>
      <a href="#ref-for-dfn-sparql-based-constraint-components-5" title="ยง 3.3 Validation with SPARQL-based Constraint Components">ยง 3.3 Validation with SPARQL-based Constraint Components</a> 
    </li><li>
      <a href="#ref-for-dfn-sparql-based-constraint-components-6" title="ยง B. Summary of SHACL Syntax Rules">ยง B. Summary of SHACL Syntax Rules</a> 
    </li>
  </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-parameter-declaration" aria-label="Links in this document to definition: parameter declarations">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-parameter-declaration" aria-label="Permalink for definition: parameter declarations. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-parameter-declaration-1" title="ยง 3.2.1 Parameter Declarations (sh:parameter)">ยง 3.2.1 Parameter Declarations (sh:parameter)</a> <a href="#ref-for-dfn-parameter-declaration-2" title="Reference 2">(2)</a> <a href="#ref-for-dfn-parameter-declaration-3" title="Reference 3">(3)</a> <a href="#ref-for-dfn-parameter-declaration-4" title="Reference 4">(4)</a> <a href="#ref-for-dfn-parameter-declaration-5" title="Reference 5">(5)</a> <a href="#ref-for-dfn-parameter-declaration-6" title="Reference 6">(6)</a> 
    </li><li>
      <a href="#ref-for-dfn-parameter-declaration-7" title="ยง B. Summary of SHACL Syntax Rules">ยง B. Summary of SHACL Syntax Rules</a> <a href="#ref-for-dfn-parameter-declaration-8" title="Reference 2">(2)</a> <a href="#ref-for-dfn-parameter-declaration-9" title="Reference 3">(3)</a> <a href="#ref-for-dfn-parameter-declaration-10" title="Reference 4">(4)</a> 
    </li>
  </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-local-names" aria-label="Links in this document to definition: local name">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-local-names" aria-label="Permalink for definition: local name. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-local-names-1" title="ยง 3.2.1 Parameter Declarations (sh:parameter)">ยง 3.2.1 Parameter Declarations (sh:parameter)</a> 
    </li><li>
      <a href="#ref-for-dfn-local-names-2" title="ยง 4. Annotation Properties">ยง 4. Annotation Properties</a> 
    </li>
  </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-parameter-names" aria-label="Links in this document to definition: parameter name">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-parameter-names" aria-label="Permalink for definition: parameter name. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-parameter-names-1" title="ยง 2.3.2 Mapping of Solution Bindings to Result Properties">ยง 2.3.2 Mapping of Solution Bindings to Result Properties</a> 
    </li><li>
      <a href="#ref-for-dfn-parameter-names-2" title="ยง 3.2.1 Parameter Declarations (sh:parameter)">ยง 3.2.1 Parameter Declarations (sh:parameter)</a> <a href="#ref-for-dfn-parameter-names-3" title="Reference 2">(2)</a> <a href="#ref-for-dfn-parameter-names-4" title="Reference 3">(3)</a> 
    </li><li>
      <a href="#ref-for-dfn-parameter-names-5" title="ยง 3.2.2 Label Templates (sh:labelTemplate)">ยง 3.2.2 Label Templates (sh:labelTemplate)</a> 
    </li><li>
      <a href="#ref-for-dfn-parameter-names-6" title="ยง 3.3 Validation with SPARQL-based Constraint Components">ยง 3.3 Validation with SPARQL-based Constraint Components</a> 
    </li><li>
      <a href="#ref-for-dfn-parameter-names-7" title="ยง B. Summary of SHACL Syntax Rules">ยง B. Summary of SHACL Syntax Rules</a> <a href="#ref-for-dfn-parameter-names-8" title="Reference 2">(2)</a> <a href="#ref-for-dfn-parameter-names-9" title="Reference 3">(3)</a> 
    </li>
  </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-label-template" aria-label="Links in this document to definition: label templates">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-label-template" aria-label="Permalink for definition: label templates. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-label-template-1" title="ยง 3.2.2 Label Templates (sh:labelTemplate)">ยง 3.2.2 Label Templates (sh:labelTemplate)</a> 
    </li>
  </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-select-based-validators" aria-label="Links in this document to definition: SELECT-based validators">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-select-based-validators" aria-label="Permalink for definition: SELECT-based validators. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-select-based-validators-1" title="ยง 2.2 Syntax of SPARQL-based Constraints">ยง 2.2 Syntax of SPARQL-based Constraints</a> 
    </li><li>
      <a href="#ref-for-dfn-select-based-validators-2" title="ยง 3.2.3.1 SELECT-based Validators">ยง 3.2.3.1 SELECT-based Validators</a> <a href="#ref-for-dfn-select-based-validators-3" title="Reference 2">(2)</a> <a href="#ref-for-dfn-select-based-validators-4" title="Reference 3">(3)</a> 
    </li><li>
      <a href="#ref-for-dfn-select-based-validators-5" title="ยง 3.3 Validation with SPARQL-based Constraint Components">ยง 3.3 Validation with SPARQL-based Constraint Components</a> 
    </li><li>
      <a href="#ref-for-dfn-select-based-validators-6" title="ยง B. Summary of SHACL Syntax Rules">ยง B. Summary of SHACL Syntax Rules</a> <a href="#ref-for-dfn-select-based-validators-7" title="Reference 2">(2)</a> <a href="#ref-for-dfn-select-based-validators-8" title="Reference 3">(3)</a> <a href="#ref-for-dfn-select-based-validators-9" title="Reference 4">(4)</a> 
    </li>
  </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-ask-based-validators" aria-label="Links in this document to definition: ASK-based validators">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-ask-based-validators" aria-label="Permalink for definition: ASK-based validators. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-ask-based-validators-1" title="ยง 3.2.3.2 ASK-based Validators">ยง 3.2.3.2 ASK-based Validators</a> <a href="#ref-for-dfn-ask-based-validators-2" title="Reference 2">(2)</a> 
    </li><li>
      <a href="#ref-for-dfn-ask-based-validators-3" title="ยง 3.3 Validation with SPARQL-based Constraint Components">ยง 3.3 Validation with SPARQL-based Constraint Components</a> 
    </li><li>
      <a href="#ref-for-dfn-ask-based-validators-4" title="ยง B. Summary of SHACL Syntax Rules">ยง B. Summary of SHACL Syntax Rules</a> <a href="#ref-for-dfn-ask-based-validators-5" title="Reference 2">(2)</a> 
    </li>
  </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-annotation-properties" aria-label="Links in this document to definition: annotation properties">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-annotation-properties" aria-label="Permalink for definition: annotation properties. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-annotation-properties-1" title="ยง G. Changes between SHACL 1.0 SPARQL and SHACL 1.2 SPARQL Extensions">ยง G. Changes between SHACL 1.0 SPARQL and SHACL 1.2 SPARQL Extensions</a> 
    </li>
  </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-result-annotation" aria-label="Links in this document to definition: result annotations">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-result-annotation" aria-label="Permalink for definition: result annotations. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-result-annotation-1" title="ยง 4. Annotation Properties">ยง 4. Annotation Properties</a> <a href="#ref-for-dfn-result-annotation-2" title="Reference 2">(2)</a> <a href="#ref-for-dfn-result-annotation-3" title="Reference 3">(3)</a> 
    </li><li>
      <a href="#ref-for-dfn-result-annotation-4" title="ยง B. Summary of SHACL Syntax Rules">ยง B. Summary of SHACL Syntax Rules</a> <a href="#ref-for-dfn-result-annotation-5" title="Reference 2">(2)</a> <a href="#ref-for-dfn-result-annotation-6" title="Reference 3">(3)</a> 
    </li>
  </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-select-expression" aria-label="Links in this document to definition: select expression">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-select-expression" aria-label="Permalink for definition: select expression. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-select-expression-1" title="ยง 5.1 Select Expressions">ยง 5.1 Select Expressions</a> <a href="#ref-for-dfn-select-expression-2" title="Reference 2">(2)</a> <a href="#ref-for-dfn-select-expression-3" title="Reference 3">(3)</a> <a href="#ref-for-dfn-select-expression-4" title="Reference 4">(4)</a> <a href="#ref-for-dfn-select-expression-5" title="Reference 5">(5)</a> 
    </li><li>
      <a href="#ref-for-dfn-select-expression-6" title="ยง B. Summary of SHACL Syntax Rules">ยง B. Summary of SHACL Syntax Rules</a> <a href="#ref-for-dfn-select-expression-7" title="Reference 2">(2)</a> 
    </li>
  </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-sparql-expr-expression" aria-label="Links in this document to definition: SPARQL expr expression">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-sparql-expr-expression" aria-label="Permalink for definition: SPARQL expr expression. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-sparql-expr-expression-1" title="ยง 5.2 SPARQL Expr Expressions">ยง 5.2 SPARQL Expr Expressions</a> <a href="#ref-for-dfn-sparql-expr-expression-2" title="Reference 2">(2)</a> <a href="#ref-for-dfn-sparql-expr-expression-3" title="Reference 3">(3)</a> <a href="#ref-for-dfn-sparql-expr-expression-4" title="Reference 4">(4)</a> 
    </li><li>
      <a href="#ref-for-dfn-sparql-expr-expression-5" title="ยง B. Summary of SHACL Syntax Rules">ยง B. Summary of SHACL Syntax Rules</a> <a href="#ref-for-dfn-sparql-expr-expression-6" title="Reference 2">(2)</a> 
    </li>
  </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-values-insertion" aria-label="Links in this document to definition: Values Insertion">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-values-insertion" aria-label="Permalink for definition: Values Insertion. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
      <li>Not referenced in this document.</li>
    </ul>
    </div><div class="dfn-panel" hidden="" role="dialog" aria-modal="true" id="dfn-panel-for-dfn-pre-binding" aria-label="Links in this document to definition: Pre-binding of variables">
      <span class="caret"></span>
      <div>
        <a class="self-link" href="#dfn-pre-binding" aria-label="Permalink for definition: Pre-binding of variables. Activate to close this dialog.">Permalink</a>
         
      </div>
      <p><b>Referenced in:</b></p>
      <ul>
    <li>
      <a href="#ref-for-dfn-pre-binding-1" title="ยง 1.2 Document Conventions">ยง 1.2 Document Conventions</a> 
    </li><li>
      <a href="#ref-for-dfn-pre-binding-2" title="ยง 2.3 Validation with SPARQL-based Constraints">ยง 2.3 Validation with SPARQL-based Constraints</a> 
    </li><li>
      <a href="#ref-for-dfn-pre-binding-3" title="ยง 2.3.1 Pre-bound Variables in SPARQL Constraints ($this, $shapesGraph, $currentShape)">ยง 2.3.1 Pre-bound Variables in SPARQL Constraints ($this, $shapesGraph, $currentShape)</a> 
    </li><li>
      <a href="#ref-for-dfn-pre-binding-4" title="ยง 3.2.3.1 SELECT-based Validators">ยง 3.2.3.1 SELECT-based Validators</a> 
    </li><li>
      <a href="#ref-for-dfn-pre-binding-5" title="ยง 3.3 Validation with SPARQL-based Constraint Components">ยง 3.3 Validation with SPARQL-based Constraint Components</a> <a href="#ref-for-dfn-pre-binding-6" title="Reference 2">(2)</a> <a href="#ref-for-dfn-pre-binding-7" title="Reference 3">(3)</a> 
    </li><li>
      <a href="#ref-for-dfn-pre-binding-8" title="ยง 5.1 Select Expressions">ยง 5.1 Select Expressions</a> <a href="#ref-for-dfn-pre-binding-9" title="Reference 2">(2)</a> <a href="#ref-for-dfn-pre-binding-10" title="Reference 3">(3)</a> 
    </li><li>
      <a href="#ref-for-dfn-pre-binding-11" title="ยง 5.2 SPARQL Expr Expressions">ยง 5.2 SPARQL Expr Expressions</a> <a href="#ref-for-dfn-pre-binding-12" title="Reference 2">(2)</a> <a href="#ref-for-dfn-pre-binding-13" title="Reference 3">(3)</a> 
    </li><li>
      <a href="#ref-for-dfn-pre-binding-14" title="ยง A. Pre-binding of Variables in SPARQL Queries">ยง A. Pre-binding of Variables in SPARQL Queries</a> 
    </li><li>
      <a href="#ref-for-dfn-pre-binding-15" title="ยง C. Potential SPARQL Definitions of SHACL Core Constraint Validators">ยง C. Potential SPARQL Definitions of SHACL Core Constraint Validators</a> 
    </li><li>
      <a href="#ref-for-dfn-pre-binding-16" title="ยง C.1 sh:targetClass">ยง C.1 sh:targetClass</a> 
    </li><li>
      <a href="#ref-for-dfn-pre-binding-17" title="ยง C.2 sh:targetSubjectsOf">ยง C.2 sh:targetSubjectsOf</a> 
    </li><li>
      <a href="#ref-for-dfn-pre-binding-18" title="ยง C.3 sh:targetObjectsOf">ยง C.3 sh:targetObjectsOf</a> 
    </li>
  </ul>
    </div><script id="respec-highlight-vars">(() => {
// @ts-check

if (document.respec) {
  document.respec.ready.then(setupVarHighlighter);
} else {
  setupVarHighlighter();
}

function setupVarHighlighter() {
  document
    .querySelectorAll("var")
    .forEach(varElem => varElem.addEventListener("click", highlightListener));
}

function highlightListener(ev) {
  ev.stopPropagation();
  const { target: varElem } = ev;
  const hightligtedElems = highlightVars(varElem);
  const resetListener = () => {
    const hlColor = getHighlightColor(varElem);
    hightligtedElems.forEach(el => removeHighlight(el, hlColor));
    [...HL_COLORS.keys()].forEach(key => HL_COLORS.set(key, true));
  };
  if (hightligtedElems.length) {
    document.body.addEventListener("click", resetListener, { once: true });
  }
}

// availability of highlight colors. colors from var.css
const HL_COLORS = new Map([
  ["respec-hl-c1", true],
  ["respec-hl-c2", true],
  ["respec-hl-c3", true],
  ["respec-hl-c4", true],
  ["respec-hl-c5", true],
  ["respec-hl-c6", true],
  ["respec-hl-c7", true],
]);

function getHighlightColor(target) {
  // return current colors if applicable
  const { value } = target.classList;
  const re = /respec-hl-\w+/;
  const activeClass = re.test(value) && value.match(re);
  if (activeClass) return activeClass[0];

  // first color preference
  if (HL_COLORS.get("respec-hl-c1") === true) return "respec-hl-c1";

  // otherwise get some other available color
  return [...HL_COLORS.keys()].find(c => HL_COLORS.get(c)) || "respec-hl-c1";
}

function highlightVars(varElem) {
  const textContent = norm(varElem.textContent);
  const parent = varElem.closest(".algorithm, section");
  const highlightColor = getHighlightColor(varElem);

  const varsToHighlight = [...parent.querySelectorAll("var")].filter(
    el =>
      norm(el.textContent) === textContent &&
      el.closest(".algorithm, section") === parent
  );

  // update availability of highlight color
  const colorStatus = varsToHighlight[0].classList.contains("respec-hl");
  HL_COLORS.set(highlightColor, colorStatus);

  // highlight vars
  if (colorStatus) {
    varsToHighlight.forEach(el => removeHighlight(el, highlightColor));
    return [];
  } else {
    varsToHighlight.forEach(el => addHighlight(el, highlightColor));
  }
  return varsToHighlight;
}

function removeHighlight(el, highlightColor) {
  el.classList.remove("respec-hl", highlightColor);
  // clean up empty class attributes so they don't come in export
  if (!el.classList.length) el.removeAttribute("class");
}

function addHighlight(elem, highlightColor) {
  elem.classList.add("respec-hl", highlightColor);
}

/**
 * Same as `norm` from src/core/utils, but our build process doesn't allow
 * imports in runtime scripts, so duplicated here.
 * @param {string} str
 */
function norm(str) {
  return str.trim().replace(/\s+/g, " ");
}
})()</script><script id="respec-dfn-panel">(() => {
// @ts-check
if (document.respec) {
  document.respec.ready.then(setupPanel);
} else {
  setupPanel();
}

function setupPanel() {
  const listener = panelListener();
  document.body.addEventListener("keydown", listener);
  document.body.addEventListener("click", listener);
}

function panelListener() {
  /** @type {HTMLElement} */
  let panel = null;
  return event => {
    const { target, type } = event;

    if (!(target instanceof HTMLElement)) return;

    // For keys, we only care about Enter key to activate the panel
    // otherwise it's activated via a click.
    if (type === "keydown" && event.key !== "Enter") return;

    const action = deriveAction(event);

    switch (action) {
      case "show": {
        hidePanel(panel);
        /** @type {HTMLElement} */
        const dfn = target.closest("dfn, .index-term");
        panel = document.getElementById(`dfn-panel-for-${dfn.id}`);
        const coords = deriveCoordinates(event);
        displayPanel(dfn, panel, coords);
        break;
      }
      case "dock": {
        panel.style.left = null;
        panel.style.top = null;
        panel.classList.add("docked");
        break;
      }
      case "hide": {
        hidePanel(panel);
        panel = null;
        break;
      }
    }
  };
}

/**
 * @param {MouseEvent|KeyboardEvent} event
 */
function deriveCoordinates(event) {
  const target = /** @type HTMLElement */ (event.target);

  // We prevent synthetic AT clicks from putting
  // the dialog in a weird place. The AT events sometimes
  // lack coordinates, so they have clientX/Y = 0
  const rect = target.getBoundingClientRect();
  if (
    event instanceof MouseEvent &&
    event.clientX >= rect.left &&
    event.clientY >= rect.top
  ) {
    // The event probably happened inside the bounding rect...
    return { x: event.clientX, y: event.clientY };
  }

  // Offset to the middle of the element
  const x = rect.x + rect.width / 2;
  // Placed at the bottom of the element
  const y = rect.y + rect.height;
  return { x, y };
}

/**
 * @param {Event} event
 */
function deriveAction(event) {
  const target = /** @type {HTMLElement} */ (event.target);
  const hitALink = !!target.closest("a");
  if (target.closest("dfn:not([data-cite]), .index-term")) {
    return hitALink ? "none" : "show";
  }
  if (target.closest(".dfn-panel")) {
    if (hitALink) {
      return target.classList.contains("self-link") ? "hide" : "dock";
    }
    const panel = target.closest(".dfn-panel");
    return panel.classList.contains("docked") ? "hide" : "none";
  }
  if (document.querySelector(".dfn-panel:not([hidden])")) {
    return "hide";
  }
  return "none";
}

/**
 * @param {HTMLElement} dfn
 * @param {HTMLElement} panel
 * @param {{ x: number, y: number }} clickPosition
 */
function displayPanel(dfn, panel, { x, y }) {
  panel.hidden = false;
  // distance (px) between edge of panel and the pointing triangle (caret)
  const MARGIN = 20;

  const dfnRects = dfn.getClientRects();
  // Find the `top` offset when the `dfn` can be spread across multiple lines
  let closestTop = 0;
  let minDiff = Infinity;
  for (const rect of dfnRects) {
    const { top, bottom } = rect;
    const diffFromClickY = Math.abs((top + bottom) / 2 - y);
    if (diffFromClickY < minDiff) {
      minDiff = diffFromClickY;
      closestTop = top;
    }
  }

  const top = window.scrollY + closestTop + dfnRects[0].height;
  const left = x - MARGIN;
  panel.style.left = `${left}px`;
  panel.style.top = `${top}px`;

  // Find if the panel is flowing out of the window
  const panelRect = panel.getBoundingClientRect();
  const SCREEN_WIDTH = Math.min(window.innerWidth, window.screen.width);
  if (panelRect.right > SCREEN_WIDTH) {
    const newLeft = Math.max(MARGIN, x + MARGIN - panelRect.width);
    const newCaretOffset = left - newLeft;
    panel.style.left = `${newLeft}px`;
    /** @type {HTMLElement} */
    const caret = panel.querySelector(".caret");
    caret.style.left = `${newCaretOffset}px`;
  }

  // As it's a dialog, we trap focus.
  // TODO: when <dialog> becomes a implemented, we should really
  // use that.
  trapFocus(panel, dfn);
}

/**
 * @param {HTMLElement} panel
 * @param {HTMLElement} dfn
 * @returns
 */
function trapFocus(panel, dfn) {
  /** @type NodeListOf<HTMLAnchorElement> elements */
  const anchors = panel.querySelectorAll("a[href]");
  // No need to trap focus
  if (!anchors.length) return;

  // Move focus to first anchor element
  const first = anchors.item(0);
  first.focus();

  const trapListener = createTrapListener(anchors, panel, dfn);
  panel.addEventListener("keydown", trapListener);

  // Hiding the panel releases the trap
  const mo = new MutationObserver(records => {
    const [record] = records;
    const target = /** @type HTMLElement */ (record.target);
    if (target.hidden) {
      panel.removeEventListener("keydown", trapListener);
      mo.disconnect();
    }
  });
  mo.observe(panel, { attributes: true, attributeFilter: ["hidden"] });
}

/**
 *
 * @param {NodeListOf<HTMLAnchorElement>} anchors
 * @param {HTMLElement} panel
 * @param {HTMLElement} dfn
 * @returns
 */
function createTrapListener(anchors, panel, dfn) {
  const lastIndex = anchors.length - 1;
  let currentIndex = 0;
  return event => {
    switch (event.key) {
      // Hitting "Tab" traps us in a nice loop around elements.
      case "Tab": {
        event.preventDefault();
        currentIndex += event.shiftKey ? -1 : +1;
        if (currentIndex < 0) {
          currentIndex = lastIndex;
        } else if (currentIndex > lastIndex) {
          currentIndex = 0;
        }
        anchors.item(currentIndex).focus();
        break;
      }

      // Hitting "Enter" on an anchor releases the trap.
      case "Enter":
        hidePanel(panel);
        break;

      // Hitting "Escape" returns focus to dfn.
      case "Escape":
        hidePanel(panel);
        dfn.focus();
        return;
    }
  };
}

/** @param {HTMLElement} panel */
function hidePanel(panel) {
  if (!panel) return;
  panel.hidden = true;
  panel.classList.remove("docked");
}
})()</script><script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script></body></html>